---
phase: 05-collectibles-scoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/config.js
  - js/main.js
  - js/renderer.js
autonomous: true

must_haves:
  truths:
    - "Gene collectibles spawn from the right edge and scroll left with a visible floating up-down motion"
    - "Each gene type (PKD1, COL4A5, NPHS1) appears as a distinct colored rectangle with its name label above it"
    - "Collecting a gene (player overlaps gene) removes the gene from the screen and awards points"
    - "Game speed increases gradually over time, making the game progressively harder"
    - "Some genes spawn near obstacles, creating a risk-reward choice"
  artifacts:
    - path: "js/config.js"
      provides: "Full GENE_TYPES with educational fields (diseaseName, description, inheritance, omimId, omimUrl, geneReviewsUrl), collectible spawn params, difficulty ramp params, restart cooldown"
      contains: "diseaseName"
    - path: "js/main.js"
      provides: "Gene array, gene spawn accumulator, floating animation update, AABB gene collection check, score state variables (distance, geneScore, collectedGenes), difficulty ramp (currentSpeed increases per frame), risk-reward spawn logic"
      contains: "geneSpawnTimer"
    - path: "js/renderer.js"
      provides: "drawGenes function rendering colored rectangles with name labels for each active gene"
      contains: "drawGenes"
  key_links:
    - from: "js/main.js"
      to: "js/config.js"
      via: "reads CONFIG.GENE_TYPES for type definitions, CONFIG.COLLECTIBLE_SPAWN_BASE_INTERVAL for timing, CONFIG.SPEED_INCREMENT for difficulty ramp"
      pattern: "CONFIG\\.GENE_TYPES|CONFIG\\.COLLECTIBLE_SPAWN"
    - from: "js/main.js"
      to: "js/renderer.js"
      via: "calls drawGenes(ctx, genes) each frame during RUNNING, DYING, PAUSED, GAME_OVER"
      pattern: "drawGenes"
    - from: "js/main.js"
      to: "checkGeneCollisions"
      via: "RUNNING state checks player overlap with each gene; on hit calls onGeneCollected"
      pattern: "checkGeneCollisions|onGeneCollected"
    - from: "js/main.js"
      to: "currentSpeed"
      via: "difficulty ramp increments currentSpeed each RUNNING frame; all movement uses currentSpeed instead of CONFIG.GAME_SPEED"
      pattern: "currentSpeed.*SPEED_INCREMENT|currentSpeed.*deltaTime"
---

<objective>
Expand config.js with full gene educational data and Phase 5 constants, implement gene collectible spawning with floating animation, AABB collection detection, score state tracking, and difficulty ramp (speed + spawn frequency increase over time). Wire gene rendering and collection into the game loop.

Purpose: This plan delivers the core collectible mechanics. After this plan, genes float across the screen, players can collect them for points, and the game gets progressively harder. Plan 02 builds on this to add the HUD display, collection feedback effects, game over education screen, high score tracking, and restart flow.

Output: Visible gene collectibles spawning, floating, and being collected. Speed ramping up over time. Score state accumulating internally (not displayed yet -- Plan 02 adds the HUD).
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-collectibles-scoring/05-CONTEXT.md
@.planning/phases/05-collectibles-scoring/05-RESEARCH.md

@js/config.js
@js/main.js
@js/renderer.js
@js/input.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand config.js with gene educational data and Phase 5 constants</name>
  <files>js/config.js</files>
  <action>
Read the current js/config.js first -- Phases 2, 3, and 4 will have already modified it with player physics, ground markers, countdown/game-over config, spawn timing, death animation constants, etc. Preserve ALL existing values.

**Replace GENE_TYPES** with the full Phase 5 version containing educational fields. The existing GENE_TYPES array has 3 entries with name/color/points. Replace it entirely with these 3 entries that include all Phase 5 educational fields:

```javascript
GENE_TYPES: [
  {
    name: 'PKD1',
    color: '#4CAF50',
    points: 10,
    width: 30,
    height: 30,
    diseaseName: 'Autosomal Dominant Polycystic Kidney Disease (ADPKD)',
    description: 'Encodes Polycystin-1, a membrane receptor controlling kidney tubule development. Mutations cause fluid-filled cysts that progressively replace kidney tissue.',
    inheritance: 'Autosomal dominant (50% transmission risk)',
    omimId: '173900',
    omimUrl: 'https://omim.org/entry/173900',
    geneReviewsUrl: 'https://www.ncbi.nlm.nih.gov/books/NBK1246/',
  },
  {
    name: 'COL4A5',
    color: '#2196F3',
    points: 15,
    width: 30,
    height: 30,
    diseaseName: 'Alport Syndrome (X-linked)',
    description: 'Encodes Collagen IV alpha-5, a key component of the glomerular basement membrane. Mutations cause progressive kidney failure, hearing loss, and eye abnormalities.',
    inheritance: 'X-linked (males severely affected; females variable)',
    omimId: '301050',
    omimUrl: 'https://omim.org/entry/301050',
    geneReviewsUrl: 'https://www.ncbi.nlm.nih.gov/books/NBK1207/',
  },
  {
    name: 'NPHS1',
    color: '#FF9800',
    points: 20,
    width: 30,
    height: 30,
    diseaseName: 'Congenital Nephrotic Syndrome (Finnish type)',
    description: 'Encodes Nephrin, the structural protein of the slit diaphragm. Loss of function causes massive protein leakage from birth.',
    inheritance: 'Autosomal recessive (both copies must be mutated)',
    omimId: '256300',
    omimUrl: 'https://omim.org/entry/256300',
    geneReviewsUrl: 'https://www.ncbi.nlm.nih.gov/books/NBK1484/',
  },
],
```

**Add these new config constants** in a clearly commented section:

```javascript
// -- Collectible spawning (Phase 5) --
COLLECTIBLE_SPAWN_BASE_INTERVAL: 3.5,   // seconds between gene spawns
COLLECTIBLE_SPAWN_VARIATION: 1.5,       // +/- seconds of randomness (yields 2-5s intervals)
COLLECTIBLE_FLOAT_AMPLITUDE: 8,         // px half peak-to-peak float
COLLECTIBLE_FLOAT_FREQ: 2.0,            // Hz (cycles per second)

// -- Risk-reward spawning (Phase 5) --
RISK_SPAWN_PROBABILITY: 0.25,           // 25% chance a gene spawns within 1s of an obstacle

// -- Scoring (Phase 5) --
PX_PER_METER: 10,                       // 10 canvas px = 1 displayed meter

// -- Restart (Phase 5) --
RESTART_COOLDOWN: 1.5,                  // seconds before Space is accepted on game over screen

// -- Gene name flash (Phase 5) --
GENE_LABEL_FLASH_DURATION: 1.0,         // seconds the gene name appears near HUD on pickup
```

**Update SPEED_INCREMENT** if it is still 5 (from Phase 1 placeholder). Change to 2 for a gentler ramp that takes ~150 seconds to reach MAX_SPEED, giving casual workshop participants 30-60 seconds of easy play before difficulty ramps noticeably. Keep GAME_SPEED and MAX_SPEED unchanged.

IMPORTANT: Keep the flat `export default { ... }` pattern. No Object.freeze. All values must remain workshop-console-mutable. Do NOT break or remove any existing config values. Do NOT import from or reference the legacy js/collectible.js, js/score.js, js/game.js files.
  </action>
  <verify>
Read js/config.js and confirm:
1. GENE_TYPES has exactly 3 entries
2. Each entry has: name, color, points, width, height, diseaseName, description, inheritance, omimId, omimUrl, geneReviewsUrl
3. GENE_TYPES[0].name === 'PKD1' with omimId '173900'
4. GENE_TYPES[1].name === 'COL4A5' with omimId '301050'
5. GENE_TYPES[2].name === 'NPHS1' with omimId '256300'
6. COLLECTIBLE_SPAWN_BASE_INTERVAL, COLLECTIBLE_SPAWN_VARIATION exist
7. COLLECTIBLE_FLOAT_AMPLITUDE, COLLECTIBLE_FLOAT_FREQ exist
8. RISK_SPAWN_PROBABILITY exists with value 0.25
9. PX_PER_METER exists with value 10
10. RESTART_COOLDOWN exists with value 1.5
11. GENE_LABEL_FLASH_DURATION exists with value 1.0
12. SPEED_INCREMENT is 2 (not 5)
13. All existing Phase 2/3/4 config values still present (GRAVITY, JUMP_VELOCITY, SPAWN_BASE_INTERVAL, DEATH_ANIMATION_DURATION, etc.)
14. No import statements for collectible.js, score.js, or game.js
  </verify>
  <done>config.js contains full Phase 5 gene type definitions (3 types with educational fields including diseaseName, description, inheritance, omimId, omimUrl, geneReviewsUrl) and all collectible spawn, scoring, restart, and difficulty ramp constants. SPEED_INCREMENT reduced to 2 for gentle ramp. All existing config values preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Implement gene spawning, floating animation, collection, difficulty ramp, and rendering</name>
  <files>js/main.js, js/renderer.js</files>
  <action>
Read the current js/main.js and js/renderer.js first. Phase 4 will have added obstacle spawning, AABB collision, DYING state, death animation, and game over overlay. Phase 3 will have the five-state machine. Understand the current code structure before modifying.

**In js/renderer.js -- Add drawGenes function:**

Add a new exported function `drawGenes(ctx, genes)` that draws each gene as a colored rectangle with a name label above it:

```javascript
export function drawGenes(ctx, genes) {
  for (const gene of genes) {
    // Colored rectangle
    ctx.fillStyle = gene.color;
    ctx.fillRect(Math.round(gene.x), Math.round(gene.y), gene.width, gene.height);

    // White border for visibility
    ctx.strokeStyle = 'rgba(255,255,255,0.5)';
    ctx.lineWidth = 1;
    ctx.strokeRect(Math.round(gene.x) + 0.5, Math.round(gene.y) + 0.5, gene.width - 1, gene.height - 1);

    // Gene name label above the rectangle
    ctx.fillStyle = '#FFFFFF';
    ctx.font = 'bold 11px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillText(gene.type, Math.round(gene.x) + gene.width / 2, Math.round(gene.y) - 2);
  }
}
```

Use `Math.round()` on x and y for crisp pixel alignment.

**In js/main.js -- Add gene collectible system:**

Add `drawGenes` to the existing import from './renderer.js'.

Add these module-level state variables (alongside existing obstacle state):

```javascript
// Gene collectible state (Phase 5)
let genes = [];
let geneSpawnTimer = 0;

// Score state (Phase 5)
let distance = 0;          // NOTE: distance may already exist from Phase 3 -- if so, keep the existing variable
let geneScore = 0;
let collectedGenes = [];   // array of typeData objects for game over education screen

// Difficulty ramp (Phase 5)
let currentSpeed = CONFIG.GAME_SPEED;  // NOTE: check if Phase 4 already introduced currentSpeed -- if so, keep existing
```

IMPORTANT: Phase 3 likely already has a `distance` variable and Phase 4 may already have a `currentSpeed` variable. If they exist, do NOT create duplicates. Instead, add `geneScore`, `collectedGenes`, `genes`, and `geneSpawnTimer` alongside the existing variables.

Add helper functions (module-level, not exported):

1. `createGene(type)` -- creates a gene collectible object:
```javascript
function createGene(type) {
  // Spawn Y in the mid-air zone reachable by jump: between ~220 and ~350 px from top
  const spawnY = 220 + Math.random() * 130;
  return {
    type: type.name,
    typeData: type,            // full config entry for education screen
    x: CONFIG.CANVAS_WIDTH + 20,
    y: spawnY,
    baseY: spawnY,             // float oscillates around this fixed Y
    width: type.width,
    height: type.height,
    color: type.color,
    points: type.points,
    floatPhase: Math.random() * Math.PI * 2,  // random phase so genes don't bob in sync
    dead: false,
  };
}
```

2. `updateGenes(deltaTime)` -- move genes left with floating animation:
```javascript
function updateGenes(deltaTime) {
  const AMP = CONFIG.COLLECTIBLE_FLOAT_AMPLITUDE;
  const FREQ = CONFIG.COLLECTIBLE_FLOAT_FREQ;

  for (const gene of genes) {
    gene.x -= currentSpeed * deltaTime;
    gene.floatPhase += FREQ * 2 * Math.PI * deltaTime;
    gene.y = gene.baseY + Math.sin(gene.floatPhase) * AMP;  // absolute from baseY -- never accumulate
    if (gene.x + gene.width < 0) gene.dead = true;
  }
  genes = genes.filter(g => !g.dead);
}
```

CRITICAL: Compute `gene.y = gene.baseY + Math.sin(...)` as an absolute value. Do NOT do `gene.y += Math.sin(...)`. The additive approach causes drift.

3. `updateGeneSpawning(deltaTime)` -- delta-time accumulator for gene spawning:
```javascript
function updateGeneSpawning(deltaTime) {
  geneSpawnTimer += deltaTime;

  // Scale spawn interval with speed ratio (faster game = more frequent genes)
  const speedRatio = currentSpeed / CONFIG.GAME_SPEED;
  const baseInterval = CONFIG.COLLECTIBLE_SPAWN_BASE_INTERVAL / Math.max(1, speedRatio * 0.5 + 0.5);
  const variation = (Math.random() - 0.5) * 2 * CONFIG.COLLECTIBLE_SPAWN_VARIATION;
  const interval = Math.max(1.5, baseInterval + variation);

  if (geneSpawnTimer >= interval) {
    geneSpawnTimer -= interval;  // subtract to preserve remainder -- critical for accuracy
    const type = CONFIG.GENE_TYPES[Math.floor(Math.random() * CONFIG.GENE_TYPES.length)];
    genes.push(createGene(type));
  }
}
```

4. `checkGeneCollisions(player)` -- AABB check for gene collection (NO hitbox shrink -- genes should be easy to collect):
```javascript
function checkGeneCollisions(player) {
  const px = player.x;
  const py = player.y;
  const pw = CONFIG.PLAYER_WIDTH;
  const ph = CONFIG.PLAYER_HEIGHT;

  for (const gene of genes) {
    if (gene.dead) continue;
    if (px < gene.x + gene.width &&
        px + pw > gene.x &&
        py < gene.y + gene.height &&
        py + ph > gene.y) {
      gene.dead = true;
      onGeneCollected(gene);
    }
  }
  genes = genes.filter(g => !g.dead);
}
```

5. `onGeneCollected(gene)` -- award points and record collection:
```javascript
function onGeneCollected(gene) {
  geneScore += gene.points;
  collectedGenes.push(gene.typeData);
  // Plan 02 will add: spawnCollectionPopup(gene.x, gene.y, '+' + gene.points);
  // Plan 02 will add: triggerGeneNameFlash(gene.typeData.name);
}
```

Leave the popup and flash calls as comments for now -- Plan 02 implements those systems.

6. `updateDifficultyRamp(deltaTime)` -- smooth speed increase:
```javascript
function updateDifficultyRamp(deltaTime) {
  currentSpeed = Math.min(currentSpeed + CONFIG.SPEED_INCREMENT * deltaTime, CONFIG.MAX_SPEED);
}
```

IMPORTANT: If Phase 3/4 already updates distance using `CONFIG.GAME_SPEED * deltaTime`, change it to use `currentSpeed * deltaTime` instead. ALL movement that previously used CONFIG.GAME_SPEED in the RUNNING state (ground scroll, obstacles, distance) must now use `currentSpeed` for the difficulty ramp to work correctly.

Specifically:
- Ground offset update in RUNNING: change `CONFIG.GAME_SPEED * deltaTime` to `currentSpeed * deltaTime`
- Obstacle movement in updateObstacles: change `CONFIG.GAME_SPEED * deltaTime` to `currentSpeed * deltaTime` (Phase 4 Plan 01 may have already used a variable for this)
- Distance accumulation: change `CONFIG.GAME_SPEED * deltaTime` to `currentSpeed * deltaTime`

**Wire into the game loop:**

In the RUNNING state branch, add calls to the new functions. Place them alongside the existing obstacle update calls:

```javascript
// In RUNNING state update block (after existing obstacle updates):
updateDifficultyRamp(deltaTime);
updateGeneSpawning(deltaTime);
updateGenes(deltaTime);
checkGeneCollisions(player);
```

Draw genes AFTER obstacles and BEFORE the player (so genes appear between obstacles and player):

```javascript
// In RUNNING state render section (after drawObstacles, before drawPlayer):
drawGenes(ctx, genes);
```

Also draw genes in PAUSED, DYING, and GAME_OVER states (frozen in place, no update):

```javascript
// In PAUSED/DYING/GAME_OVER state render sections:
drawGenes(ctx, genes);
```

**Extend resetGame():**

Add gene/score/difficulty reset to the existing resetGame function:

```javascript
genes = [];
geneSpawnTimer = 0;
geneScore = 0;
collectedGenes = [];
currentSpeed = CONFIG.GAME_SPEED;
// Keep highScore (Plan 02 adds localStorage persistence)
```

IMPORTANT: Only call gene update functions when `gameState === 'RUNNING'`. Do NOT update genes during COUNTDOWN, PAUSED, DYING, or GAME_OVER.

IMPORTANT: Do NOT import from or reference the legacy js/collectible.js, js/score.js, or js/game.js files. They are incompatible.

IMPORTANT: Only use `import CONFIG from './config.js'` (default import). Do NOT use named imports `{ GENE_TYPES }` from config -- they resolve to undefined.
  </action>
  <verify>
Read js/main.js and confirm:
1. Contains `let genes = []` and `let geneSpawnTimer = 0`
2. Contains `let geneScore = 0` and `let collectedGenes = []`
3. Contains `let currentSpeed = CONFIG.GAME_SPEED` (or reuses existing if Phase 4 introduced it)
4. Contains `createGene`, `updateGenes`, `updateGeneSpawning`, `checkGeneCollisions`, `onGeneCollected`, `updateDifficultyRamp` functions
5. `createGene` initializes `baseY` and `floatPhase` with random values
6. `updateGenes` computes `gene.y = gene.baseY + Math.sin(gene.floatPhase) * AMP` (absolute, not additive)
7. `updateGeneSpawning` uses `geneSpawnTimer -= interval` (not `geneSpawnTimer = 0`)
8. `checkGeneCollisions` uses NO hitbox shrink on genes (full AABB)
9. `updateDifficultyRamp` increments `currentSpeed` and caps at `CONFIG.MAX_SPEED`
10. RUNNING state calls all gene update functions
11. Ground scroll, obstacle movement, and distance all use `currentSpeed` (not `CONFIG.GAME_SPEED`)
12. PAUSED and GAME_OVER states draw genes but do NOT update them
13. `resetGame` clears genes, geneSpawnTimer, geneScore, collectedGenes, and resets currentSpeed
14. `drawGenes` imported from renderer.js
15. No imports from collectible.js, score.js, or game.js

Read js/renderer.js and confirm:
1. Contains `export function drawGenes(ctx, genes)`
2. drawGenes iterates array, draws colored fillRect + white strokeRect + name label for each gene
3. Uses Math.round on x and y positions

Open index.html in browser:
1. Start the game, play for a few seconds
2. Colored rectangles with gene labels (PKD1, COL4A5, NPHS1) should spawn from the right
3. Genes should visibly float up and down with a smooth sine wave motion
4. Running into a gene makes it disappear (collected)
5. Game speed should noticeably increase after ~60 seconds
6. Obstacles also speed up (same currentSpeed drives everything)
7. No console errors
  </verify>
  <done>Gene collectibles spawn as colored rectangles with name labels, float with per-gene sine animation, and disappear on player collision (AABB collection). Score state (geneScore, collectedGenes) tracks internally. Difficulty ramp increases currentSpeed each frame. All movement (ground, obstacles, genes, distance) uses currentSpeed for consistent difficulty scaling. Spawn frequency also scales with speed ratio. resetGame clears all Phase 5 state.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Open index.html in browser, start the game
2. Gene collectibles (colored rectangles labeled PKD1, COL4A5, NPHS1) spawn from the right
3. Genes float up and down smoothly (not all in sync -- each has random phase)
4. Running into a gene makes it disappear
5. Game speed increases noticeably after ~60 seconds
6. Both obstacles and genes move faster as difficulty ramps
7. Pause freezes genes in place; resume continues them
8. Restart clears all genes and resets speed to initial
9. CONFIG.COLLECTIBLE_SPAWN_BASE_INTERVAL = 0.5 in console makes genes spawn rapidly
10. CONFIG.SPEED_INCREMENT = 20 in console makes difficulty ramp very fast
11. No console errors
</verification>

<success_criteria>
1. Three gene types visible as distinct colored rectangles with name labels
2. Floating sine animation with per-gene phase offset (organic, not synchronized)
3. Gene collection works via AABB overlap (no shrink -- easy to collect)
4. Score state tracks internally (geneScore, collectedGenes populated on collection)
5. Difficulty ramp works (speed increases gradually, all movement scales)
6. Spawn frequency scales with speed ratio
7. Genes freeze during PAUSED, DYING, GAME_OVER states
8. All spawn/timing/difficulty values tunable via CONFIG in browser console
9. Zero console errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-collectibles-scoring/05-01-SUMMARY.md`
</output>
