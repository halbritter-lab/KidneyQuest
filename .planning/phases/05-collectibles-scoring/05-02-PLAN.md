---
phase: 05-collectibles-scoring
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - js/main.js
  - js/renderer.js
autonomous: false

must_haves:
  truths:
    - "Live score (distance in meters + gene count) displays in the top-right corner during RUNNING state"
    - "Collecting a gene triggers a floating '+N' popup that drifts upward and fades out"
    - "Collecting a gene triggers a brief gene name flash (e.g. 'PKD1!') near the score counter"
    - "Game over screen shows score breakdown: distance, gene score, total score, and high score comparison"
    - "Game over screen shows educational gene cards with disease name, description, inheritance, and OMIM ID for each collected gene"
    - "High score persists across sessions via localStorage"
    - "Space/tap after 1.5-second cooldown on game over screen fully restarts the game"
    - "Gene cards display up to 5 most recent genes collected; excess shows a summary count"
  artifacts:
    - path: "js/main.js"
      provides: "Popup particle array, gene flash state, high score via localStorage (loadHighScore/saveHighScore), game over timer with restart cooldown, full resetGame covering all Phase 5 state, getTotalScore helper"
      contains: "loadHighScore"
    - path: "js/renderer.js"
      provides: "drawHUD (extended with gene count + total score), drawPopups, drawGeneFlash, drawGameOverScreen (educational gene cards with score breakdown)"
      contains: "drawGameOverScreen"
  key_links:
    - from: "js/main.js"
      to: "js/renderer.js"
      via: "RUNNING state calls drawHUD (extended), drawPopups, drawGeneFlash; GAME_OVER state calls drawGameOverScreen"
      pattern: "drawPopups|drawGeneFlash|drawGameOverScreen"
    - from: "js/main.js"
      to: "localStorage"
      via: "loadHighScore reads on init and after restart; saveHighScore writes on game over if new record"
      pattern: "localStorage\\.getItem|localStorage\\.setItem"
    - from: "js/main.js"
      to: "onGeneCollected"
      via: "collection callback spawns popup particle and triggers gene name flash"
      pattern: "spawnCollectionPopup|triggerGeneNameFlash"
    - from: "js/renderer.js"
      to: "drawGeneCards"
      via: "game over screen renders educational cards for each collected gene with disease info and OMIM IDs"
      pattern: "drawGeneCards|diseaseName|omimId"
---

<objective>
Implement the live HUD (distance + gene count + total score), floating "+N" popup particles on collection, gene name flash feedback, localStorage high score persistence, and the full educational game over screen with score breakdown, gene cards showing disease information, and restart flow with cooldown.

Purpose: This plan completes the player-facing experience of Phase 5. After this plan, players see their score during gameplay, get satisfying visual feedback when collecting genes, learn about kidney disease genetics on the game over screen, track their high score across sessions, and can restart for another run. This delivers the complete gameplay loop.

Output: Full Phase 5 UX: live HUD, collection feedback, educational game over screen, high score, and restart.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-collectibles-scoring/05-CONTEXT.md
@.planning/phases/05-collectibles-scoring/05-RESEARCH.md
@.planning/phases/05-collectibles-scoring/05-01-SUMMARY.md

@js/config.js
@js/main.js
@js/renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement popup particles, gene flash, HUD, high score, game over screen, and restart</name>
  <files>js/main.js, js/renderer.js</files>
  <action>
Read the current js/main.js and js/renderer.js first. Plan 01 will have added gene spawning, collection, score state (geneScore, collectedGenes, distance), difficulty ramp (currentSpeed), and the onGeneCollected callback with placeholder comments for popups and flash. Understand the full current structure.

**In js/main.js -- Add popup particles, gene flash, high score, and game over restart:**

1. **Add state variables** (alongside existing Phase 5 state from Plan 01):

```javascript
// Floating popup particles (Phase 5)
let popups = [];

// Gene name flash (Phase 5)
let geneFlashName = null;
let geneFlashTimer = 0;

// Game over timer (Phase 5) -- may already exist from Phase 3/4. If so, keep existing.
// let gameOverTimer = 0;  // already exists from Phase 3

// High score (Phase 5)
let highScore = 0;
```

NOTE: `gameOverTimer` likely already exists from Phase 3. Do NOT create a duplicate. Reuse it.

2. **localStorage high score functions:**

```javascript
const LS_KEY = 'kidneyquest_highscore';

function loadHighScore() {
  try {
    const raw = localStorage.getItem(LS_KEY);
    const parsed = parseInt(raw, 10);
    return isNaN(parsed) ? 0 : parsed;
  } catch (e) {
    return 0;  // localStorage unavailable (private browsing, etc.)
  }
}

function saveHighScore(score) {
  try {
    const current = loadHighScore();
    if (score > current) {
      localStorage.setItem(LS_KEY, String(score));
      return true;  // new high score
    }
    return false;
  } catch (e) {
    return false;
  }
}
```

3. **Initialize highScore on load:**

Right after the existing module-level variable declarations, add:
```javascript
highScore = loadHighScore();
```

4. **Score helper:**

```javascript
function getTotalScore() {
  return geneScore + Math.floor(distance / CONFIG.PX_PER_METER);
}
```

5. **Popup particle functions:**

```javascript
function spawnCollectionPopup(x, y, text) {
  popups.push({ x, y, text, alpha: 1.0, vy: -60 });
}

function updatePopups(deltaTime) {
  for (const p of popups) {
    p.y += p.vy * deltaTime;
    p.alpha -= 1.2 * deltaTime;
  }
  popups = popups.filter(p => p.alpha > 0);
}
```

6. **Gene name flash functions:**

```javascript
function triggerGeneNameFlash(name) {
  geneFlashName = name + '!';
  geneFlashTimer = CONFIG.GENE_LABEL_FLASH_DURATION;
}

function updateGeneFlash(deltaTime) {
  if (geneFlashTimer > 0) {
    geneFlashTimer = Math.max(0, geneFlashTimer - deltaTime);
    if (geneFlashTimer === 0) geneFlashName = null;
  }
}
```

7. **Update onGeneCollected** (from Plan 01) to call popup and flash:

Remove the placeholder comments and add the actual calls:
```javascript
function onGeneCollected(gene) {
  geneScore += gene.points;
  collectedGenes.push(gene.typeData);
  spawnCollectionPopup(gene.x, gene.y, '+' + gene.points);
  triggerGeneNameFlash(gene.typeData.name);
}
```

8. **Wire popup and flash updates into RUNNING state:**

Add to the RUNNING state update block (alongside existing gene updates):
```javascript
updatePopups(deltaTime);
updateGeneFlash(deltaTime);
```

Also update popups during DYING and GAME_OVER so they can finish fading out:
```javascript
// In DYING state update:
updatePopups(deltaTime);

// In GAME_OVER state update:
updatePopups(deltaTime);
```

9. **Update game over transition:**

When transitioning to GAME_OVER (which happens from DYING state when deathTimer expires), add:
```javascript
// When entering GAME_OVER:
const isNewRecord = saveHighScore(getTotalScore());
highScore = loadHighScore();  // re-read in case just set
gameOverTimer = 0;
```

Find where `gameState = 'GAME_OVER'` is set (in the DYING state timer check) and add the saveHighScore call there.

10. **Update handleAction for GAME_OVER restart:**

The Phase 3/4 handleAction already handles GAME_OVER with a cooldown check. Update the cooldown to use `CONFIG.RESTART_COOLDOWN` instead of whatever value Phase 3/4 used. The restart should call the existing resetGame function:

```javascript
// In handleAction, GAME_OVER branch:
if (gameState === 'GAME_OVER') {
  if (gameOverTimer >= CONFIG.RESTART_COOLDOWN) {
    resetGame();
  }
}
```

If the existing code uses a different cooldown constant (like GAME_OVER_COOLDOWN + GAME_OVER_FREEZE_DELAY from Phase 3/4), replace it with `CONFIG.RESTART_COOLDOWN`. Phase 5 simplifies this: GAME_OVER state has its own timer, restart allowed after RESTART_COOLDOWN (1.5s).

11. **Extend resetGame** to clear popup/flash/highScore state:

```javascript
// Add to existing resetGame:
popups = [];
geneFlashName = null;
geneFlashTimer = 0;
highScore = loadHighScore();  // re-read on restart
```

**In js/renderer.js -- Add HUD extension, popup drawing, gene flash, and game over screen:**

Add `drawPopups`, `drawGeneFlash`, and `drawGameOverScreen` as new exported functions. Also extend or replace the existing `drawHUD` to include gene count and total score.

1. **Extend drawHUD** (or create a new version). The Phase 3 HUD shows only distance. Extend to show gene count and total score:

```javascript
export function drawHUD(ctx, config, distance, geneCount, totalScore) {
  const meters = Math.floor(distance / config.PX_PER_METER);

  // Distance + gene count (top line)
  drawText(ctx, meters + 'm | Genes: ' + geneCount,
    config.CANVAS_WIDTH - 20, 30,
    { font: 'bold 22px sans-serif', color: '#FFFFFF', align: 'right', baseline: 'top' }
  );

  // Total score (second line)
  drawText(ctx, 'Score: ' + totalScore,
    config.CANVAS_WIDTH - 20, 58,
    { font: '18px sans-serif', color: '#FFD700', align: 'right', baseline: 'top' }
  );
}
```

IMPORTANT: If the existing drawHUD has a different signature (e.g., `drawHUD(ctx, config, distance)`), update ALL call sites in main.js to pass the new parameters. The RUNNING, PAUSED, DYING, and GAME_OVER states may all call drawHUD.

Update all drawHUD call sites in main.js to pass the new params:
```javascript
drawHUD(ctx, CONFIG, distance, collectedGenes.length, getTotalScore());
```

2. **drawPopups function:**

```javascript
export function drawPopups(ctx, popups) {
  for (const p of popups) {
    ctx.save();
    ctx.globalAlpha = Math.max(0, p.alpha);
    ctx.fillStyle = '#FFD700';
    ctx.font = 'bold 22px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(p.text, Math.round(p.x), Math.round(p.y));
    ctx.restore();
  }
}
```

3. **drawGeneFlash function:**

```javascript
export function drawGeneFlash(ctx, config, geneFlashName, geneFlashTimer) {
  if (!geneFlashName || geneFlashTimer <= 0) return;
  const alpha = Math.min(1.0, geneFlashTimer / 0.3);  // fade out in last 0.3s
  ctx.save();
  ctx.globalAlpha = alpha;
  ctx.fillStyle = '#FFD700';
  ctx.font = 'bold 18px sans-serif';
  ctx.textAlign = 'right';
  ctx.textBaseline = 'top';
  ctx.fillText(geneFlashName, config.CANVAS_WIDTH - 20, 84);
  ctx.restore();
}
```

4. **drawGameOverScreen function** -- the educational game over screen:

This is a substantial rendering function. It draws:
- Semi-transparent overlay
- "GAME OVER" title
- Score breakdown (distance, gene score, total)
- High score comparison (or "NEW HIGH SCORE!" if beaten)
- Gene cards (up to 5 most recent) with disease info
- Pulsing restart prompt after cooldown

```javascript
export function drawGameOverScreen(ctx, config, options) {
  // options: { distance, geneScore, totalScore, highScore, isNewRecord,
  //            collectedGenes, gameOverTimer, restartCooldown }

  const cx = config.CANVAS_WIDTH / 2;

  // Semi-transparent overlay
  ctx.fillStyle = 'rgba(0, 0, 10, 0.88)';
  ctx.fillRect(0, 0, config.CANVAS_WIDTH, config.CANVAS_HEIGHT);

  // Title
  drawText(ctx, 'GAME OVER', cx, 60,
    { font: 'bold 48px sans-serif', color: '#FF4444' });

  // Score breakdown
  const meters = Math.floor(options.distance / config.PX_PER_METER);
  drawText(ctx, 'Distance: ' + meters + 'm', cx, 115,
    { font: '24px sans-serif', color: '#FFFFFF' });
  drawText(ctx, 'Gene Score: ' + options.geneScore, cx, 145,
    { font: '24px sans-serif', color: '#FFFFFF' });
  drawText(ctx, 'Total: ' + options.totalScore, cx, 180,
    { font: 'bold 28px sans-serif', color: '#FFD700' });

  // High score comparison
  if (options.isNewRecord) {
    drawText(ctx, 'NEW HIGH SCORE!', cx, 212,
      { font: 'bold 20px sans-serif', color: '#00FF88' });
  } else if (options.highScore > 0) {
    drawText(ctx, 'Best: ' + options.highScore, cx, 212,
      { font: '18px sans-serif', color: '#AAAAAA' });
  }

  // Gene cards (up to 5 most recent)
  const displayGenes = options.collectedGenes.slice(-5);
  const uniqueGenes = [];
  const seen = new Set();
  for (const g of displayGenes) {
    if (!seen.has(g.name)) {
      seen.add(g.name);
      uniqueGenes.push(g);
    }
  }

  if (uniqueGenes.length > 0) {
    drawText(ctx, 'Genes Collected:', cx, 245,
      { font: 'bold 18px sans-serif', color: '#FFFFFF' });

    const cardW = 500;
    const cardH = 80;
    const cardX = (config.CANVAS_WIDTH - cardW) / 2;
    let cardY = 265;

    for (const gene of uniqueGenes) {
      // Card background
      ctx.fillStyle = 'rgba(255,255,255,0.08)';
      ctx.fillRect(cardX, cardY, cardW, cardH);

      // Left color stripe
      ctx.fillStyle = gene.color;
      ctx.fillRect(cardX, cardY, 6, cardH);

      // Gene name + points
      drawText(ctx, gene.name + '  (+' + gene.points + 'pts)',
        cardX + 20, cardY + 16,
        { font: 'bold 15px sans-serif', color: gene.color, align: 'left', baseline: 'top' });

      // Disease name + inheritance
      drawText(ctx, gene.diseaseName + ' - ' + gene.inheritance,
        cardX + 20, cardY + 34,
        { font: '12px sans-serif', color: '#CCCCCC', align: 'left', baseline: 'top' });

      // Short description
      drawText(ctx, gene.description.length > 90 ? gene.description.substring(0, 87) + '...' : gene.description,
        cardX + 20, cardY + 50,
        { font: '11px sans-serif', color: '#999999', align: 'left', baseline: 'top' });

      // OMIM ID
      drawText(ctx, 'OMIM: ' + gene.omimId,
        cardX + 20, cardY + 65,
        { font: '10px sans-serif', color: '#777777', align: 'left', baseline: 'top' });

      cardY += cardH + 6;
    }

    // Overflow message
    if (options.collectedGenes.length > 5) {
      drawText(ctx, '...and ' + (options.collectedGenes.length - 5) + ' more genes collected',
        cx, cardY + 10,
        { font: '14px sans-serif', color: '#888888' });
    }
  } else {
    drawText(ctx, 'No genes collected this run', cx, 260,
      { font: '18px sans-serif', color: '#666666' });
  }

  // Restart prompt (after cooldown)
  if (options.gameOverTimer >= options.restartCooldown) {
    const pulse = 0.4 + 0.6 * Math.abs(Math.sin(options.gameOverTimer * 2.5));
    drawText(ctx, 'Press Space to restart', cx, config.CANVAS_HEIGHT - 40,
      { font: '22px sans-serif', color: '#FFFFFF', alpha: pulse });
  }
}
```

5. **Update imports in main.js:**

Add the new renderer functions to the existing import:
```javascript
import { ..., drawPopups, drawGeneFlash, drawGameOverScreen } from './renderer.js';
```

6. **Wire rendering into game loop states in main.js:**

In RUNNING state render section (after drawHUD):
```javascript
drawPopups(ctx, popups);
drawGeneFlash(ctx, CONFIG, geneFlashName, geneFlashTimer);
```

In GAME_OVER state render section -- REPLACE the existing Phase 4 game over overlay (drawGameOver or drawGameOverOverlay) with the new educational screen:
```javascript
drawGameOverScreen(ctx, CONFIG, {
  distance: distance,
  geneScore: geneScore,
  totalScore: getTotalScore(),
  highScore: highScore,
  isNewRecord: getTotalScore() >= highScore && highScore > 0,
  collectedGenes: collectedGenes,
  gameOverTimer: gameOverTimer,
  restartCooldown: CONFIG.RESTART_COOLDOWN,
});
```

Remove or replace the old Phase 4 `drawGameOver`/`drawGameOverOverlay` call in the GAME_OVER state with this new call. The Phase 4 game over was a simpler overlay showing "Game Over" + killer obstacle name. The Phase 5 version is a full educational screen that subsumes it. If you want to preserve the killer obstacle info, you can add `killerObstacleName` to the options and display it in the game over screen.

In DYING state, still draw the death animation (from Phase 4) -- do NOT replace that.

In PAUSED state, also render popups (in case any are mid-fade):
```javascript
drawPopups(ctx, popups);
```

IMPORTANT: The drawHUD signature change means ALL existing call sites must be updated. Search for every drawHUD call in main.js and update to pass `collectedGenes.length` and `getTotalScore()`.

IMPORTANT: Do NOT import from or reference the legacy js/score.js or js/game.js files.
  </action>
  <verify>
Read js/main.js and confirm:
1. Contains `let popups = []` and popup management functions (spawnCollectionPopup, updatePopups)
2. Contains `let geneFlashName`, `let geneFlashTimer` and flash functions (triggerGeneNameFlash, updateGeneFlash)
3. Contains `loadHighScore`, `saveHighScore` with try/catch wrapping localStorage calls
4. Contains `getTotalScore` returning `geneScore + Math.floor(distance / CONFIG.PX_PER_METER)`
5. `onGeneCollected` calls spawnCollectionPopup AND triggerGeneNameFlash
6. RUNNING state updates popups and gene flash
7. GAME_OVER entry saves high score via saveHighScore
8. GAME_OVER state renders drawGameOverScreen with all score data
9. handleAction GAME_OVER branch uses CONFIG.RESTART_COOLDOWN
10. resetGame clears popups, geneFlashName, geneFlashTimer, reloads highScore
11. All drawHUD calls pass gene count and total score
12. No imports from score.js or game.js

Read js/renderer.js and confirm:
1. drawHUD accepts distance, geneCount, totalScore parameters
2. drawHUD renders "Xm | Genes: N" and "Score: N" in top-right corner
3. Contains `export function drawPopups(ctx, popups)` with globalAlpha fade
4. Contains `export function drawGeneFlash(ctx, config, geneFlashName, geneFlashTimer)` with fade-out
5. Contains `export function drawGameOverScreen(ctx, config, options)` with overlay, score breakdown, gene cards with disease info and OMIM IDs, high score comparison, and pulsing restart prompt
6. drawGameOverScreen truncates long descriptions and caps gene cards at 5

Open index.html in browser:
1. Start the game and collect a gene -- floating "+N" gold text appears and drifts up
2. On collection, gene name flashes briefly near the score counter (e.g., "PKD1!")
3. HUD shows "Xm | Genes: N" and "Score: N" in top-right
4. Die (hit an obstacle), wait for death animation
5. Game over screen appears with dark overlay, "GAME OVER" title
6. Score breakdown: distance, gene score, total
7. Gene cards show collected genes with disease name, description, inheritance, OMIM ID
8. After 1.5s, pulsing "Press Space to restart" appears
9. Press Space -- game fully restarts (clean state, speed reset, score zero)
10. Play again, beat your score -- "NEW HIGH SCORE!" appears on game over
11. Refresh page -- high score persists (localStorage)
12. No console errors
  </verify>
  <done>Live HUD displays distance, gene count, and total score. Gene collection triggers floating "+N" gold popup and gene name flash. Game over screen shows full educational content: score breakdown, high score comparison, gene cards with disease name, description, inheritance pattern, and OMIM ID. High score persists via localStorage. Restart after 1.5s cooldown fully resets all state.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 5: Collectibles + Scoring. Gene collectibles (PKD1, COL4A5, NPHS1) spawn as colored rectangles with floating animation. Collection triggers "+N" popup and gene name flash. Live HUD shows distance, gene count, and total score. Difficulty ramps smoothly (speed + spawn frequency). Game over screen shows educational gene cards with kidney disease information and OMIM IDs. High score via localStorage. Restart after cooldown.</what-built>
  <how-to-verify>
1. Open http://localhost:8080 (or serve with `npx http-server -p 8080 -c-1`)
2. Press Space to start -- countdown, then game begins
3. Observe colored rectangles with gene labels (PKD1 green, COL4A5 blue, NPHS1 orange) spawning from right
4. Genes should float up and down smoothly (not all in sync)
5. Check top-right corner: "0m | Genes: 0" and "Score: 0" visible
6. Collect a gene by running into it:
   a. Gene disappears
   b. Gold "+N" text floats up and fades from the collection point
   c. Gene name flashes briefly near the score counter (e.g., "PKD1!")
   d. Gene counter increments, score updates
7. Play for 60+ seconds -- notice the game getting faster (subtle at first)
8. Die (hit an obstacle):
   a. Death animation plays (flash + shake from Phase 4)
   b. Dark overlay appears with "GAME OVER" in red
   c. Score breakdown: distance in meters, gene score, total
   d. Gene cards show collected genes with disease name, description, inheritance, OMIM ID
   e. After ~1.5 seconds, pulsing "Press Space to restart" appears
9. Press Space -- game fully restarts (speed reset, score zero, genes cleared)
10. Play again and beat your score -- verify "NEW HIGH SCORE!" appears
11. Refresh the page -- high score should persist (check with a second game over)
12. Open console: type `CONFIG.COLLECTIBLE_SPAWN_BASE_INTERVAL = 0.5` -- genes spawn rapidly
13. Open console: type `CONFIG.SPEED_INCREMENT = 20` -- game ramps to max speed very quickly
14. Verify no console errors throughout
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with gene feel, score display, game over screen layout, or difficulty pacing</resume-signal>
</task>

</tasks>

<verification>
Phase 5 success criteria (from ROADMAP.md):
1. Gene collectibles spawn, scroll left with a floating up-down motion, and disappear when collected
2. Score (distance traveled + genes collected) displays on screen during gameplay
3. Multiple gene types (PKD1, COL4A5, NPHS1) appear with different point values, defined in config
4. Pressing Space or tapping on the game over screen restarts the game from scratch
5. Game speed increases gradually over time, making the game progressively harder

Additional criteria from CONTEXT.md decisions:
6. Each gene type has a distinct color-coded rectangle with name label
7. Live score in top-right (classic arcade placement) with separate distance and gene count
8. Floating "+N" popup on collection (classic arcade feedback)
9. Gene name briefly flashes near gene counter on pickup
10. Score breakdown on game over screen with gene education content
11. Expandable gene detail shown as always-visible info (inheritance, OMIM ID)
12. High score via localStorage with current vs best comparison
13. Brief pause (1.5s) before restart is allowed
14. Smooth continuous speed increase with max cap
15. Both speed and spawn frequency increase with difficulty
</verification>

<success_criteria>
1. Three gene types visible with distinct colors, name labels, and floating animation
2. Collection feedback: "+N" popup floats up and fades, gene name flashes near counter
3. Live HUD shows distance, gene count, and total score during gameplay
4. Game over screen is educational: disease names, descriptions, inheritance, OMIM IDs
5. High score persists via localStorage and shows comparison on game over
6. Restart fully resets everything (speed, score, genes, obstacles)
7. Difficulty ramp is smooth and noticeable after 60+ seconds
8. All values tunable via CONFIG in browser console
9. Zero console errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-collectibles-scoring/05-02-SUMMARY.md`
</output>
