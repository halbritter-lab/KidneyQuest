---
phase: 04-obstacles-collision
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/config.js
  - js/main.js
  - js/renderer.js
autonomous: true

must_haves:
  truths:
    - "Rectangle obstacles spawn at the right edge and scroll left toward the player"
    - "Obstacles use three visually distinct colors (brown stone, green toxin, light-blue salt crystal)"
    - "Only kidney stones appear in the first 10 seconds; toxins unlock after ~10s; salt crystals after ~20s"
    - "Floating obstacles appear above ground level after ~15-20 seconds"
    - "Clusters of 2-3 obstacles occasionally spawn together with visible gaps between them"
    - "Obstacles freeze in place when game is paused or in game over state"
  artifacts:
    - path: "js/config.js"
      provides: "Full obstacle type definitions with hitboxShrink, placement, floatHeight, unlockAfter, spawnWeight, displayName; spawn timing constants; death/shake/near-miss constants"
      contains: "hitboxShrink"
    - path: "js/main.js"
      provides: "Obstacle array, spawn timer with delta-time accumulator, weighted random selection, progressive type unlocking, cluster spawning, obstacle movement and off-screen removal"
      contains: "spawnTimer"
    - path: "js/renderer.js"
      provides: "drawObstacles function rendering colored rectangles for each active obstacle"
      contains: "drawObstacles"
  key_links:
    - from: "js/main.js"
      to: "js/config.js"
      via: "reads CONFIG.OBSTACLE_TYPES for type definitions and CONFIG.SPAWN_BASE_INTERVAL for timing"
      pattern: "CONFIG\\.OBSTACLE_TYPES|CONFIG\\.SPAWN_BASE_INTERVAL"
    - from: "js/main.js"
      to: "js/renderer.js"
      via: "calls drawObstacles(ctx, obstacles) each frame during RUNNING, DYING, PAUSED, GAME_OVER"
      pattern: "drawObstacles"
    - from: "js/main.js"
      to: "updateObstacles"
      via: "game loop calls updateObstacles only during RUNNING state"
      pattern: "updateObstacles.*deltaTime"
---

<objective>
Add the Phase 4 obstacle type configuration, implement the obstacle spawning system with progressive type introduction and cluster spawning, render obstacles as colored rectangles, and wire obstacle movement into the game loop.

Purpose: This plan delivers the visible obstacle threat in KidneyQuest. After this plan, obstacles spawn, scroll left, and disappear off-screen. They are the foundation that Plan 02 adds collision detection and death mechanics to. The spawn system is data-driven via CONFIG so workshop participants can tweak timing and types in the browser console.

Output: Obstacles visibly spawning and scrolling across the game canvas with progressive difficulty and occasional clusters.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-obstacles-collision/04-CONTEXT.md
@.planning/phases/04-obstacles-collision/04-RESEARCH.md

@js/config.js
@js/main.js
@js/renderer.js
@js/input.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand config.js with full obstacle type data and Phase 4 constants</name>
  <files>js/config.js</files>
  <action>
Read the current js/config.js first -- Phase 2 and Phase 3 will have already modified it with player physics constants, ground marker config, countdown/game-over config, rich entity arrays, etc. Preserve ALL existing values.

**Replace OBSTACLE_TYPES** with the full Phase 4 version. The existing OBSTACLE_TYPES array (from Phase 3) has 3 entries with name/width/height/color/spawnRate/movement. Replace it entirely with these 3 entries that include all Phase 4 fields:

```javascript
OBSTACLE_TYPES: [
  {
    name: 'kidney-stone',
    displayName: 'Kidney Stone',
    width: 32,
    height: 42,
    color: '#8B6914',           // earthy brown
    hitboxShrink: 0.15,         // 15% shrink on each side
    placement: 'ground',        // sits on GROUND_Y
    floatHeight: 0,
    spawnWeight: 3,             // most common
    unlockAfter: 0,             // available from start
  },
  {
    name: 'toxin',
    displayName: 'Toxin',
    width: 28,
    height: 36,
    color: '#2E8B3A',           // mid-green
    hitboxShrink: 0.15,
    placement: 'ground',
    floatHeight: 0,
    spawnWeight: 2,
    unlockAfter: 10,            // unlocks ~10s in
  },
  {
    name: 'salt-crystal',
    displayName: 'Salt Crystal',
    width: 24,
    height: 52,                 // tall
    color: '#B0C8E0',           // white/light-blue
    hitboxShrink: 0.20,         // more forgiving for tall obstacle
    placement: 'floating',
    floatHeight: 120,           // px above GROUND_Y -- at jump apex
    spawnWeight: 1,
    unlockAfter: 20,            // unlocks ~20s in
  },
],
```

**Add these new config constants** (add them in a clearly commented section after the existing obstacle/gene arrays):

```javascript
// -- Spawn timing (Phase 4) --
SPAWN_BASE_INTERVAL: 2.0,       // seconds between spawns
SPAWN_INTERVAL_VARIATION: 0.6,  // +/- random variation in seconds
FLOAT_UNLOCK_ELAPSED: 15,       // seconds before floating obstacles can appear

// -- Cluster spawning (Phase 4) --
CLUSTER_PROBABILITY: 0.25,      // 25% chance a spawn triggers a cluster
CLUSTER_SIZE_MAX: 3,            // max obstacles in a cluster
CLUSTER_GAP: 180,               // px gap between cluster members

// -- Hitbox (Phase 4) --
PLAYER_HITBOX_SHRINK: 0.15,     // player collision box shrink (same 15%)

// -- Death animation (Phase 4) --
DEATH_ANIMATION_DURATION: 0.5,  // seconds of flash + shake before game over
DEATH_FLASH_INTERVAL: 0.08,     // seconds per flash on/off toggle
DEATH_SHAKE_DURATION: 0.4,      // seconds of screen shake within death window
SHAKE_AMPLITUDE: 8,             // px max shake offset

// -- Near-miss (Phase 4) --
NEAR_MISS_FLASH_COLOR: '#FFFF44',  // yellow flash
NEAR_MISS_FLASH_DURATION: 0.15,    // seconds of near-miss flash

// -- Game over overlay (Phase 4) --
GAME_OVER_OVERLAY_ALPHA: 0.72,     // overlay darkness
```

If Phase 3 already defined GAME_OVER_COOLDOWN, keep the existing value but note that Phase 4 Plan 02 will adjust the game over flow to include the DYING state before GAME_OVER.

IMPORTANT: Keep the flat `export default { ... }` pattern. No Object.freeze. All values must remain workshop-console-mutable. Do NOT break or remove any existing config values (player physics, ground markers, countdown, HUD, gene types, etc).

IMPORTANT: Do NOT import from or reference the legacy js/collision.js, js/obstacle.js, or js/game.js files. They are incompatible.
  </action>
  <verify>
Read js/config.js and confirm:
1. OBSTACLE_TYPES has exactly 3 entries
2. Each entry has: name, displayName, width, height, color, hitboxShrink, placement, floatHeight, spawnWeight, unlockAfter
3. OBSTACLE_TYPES[0].name === 'kidney-stone' with hitboxShrink 0.15
4. OBSTACLE_TYPES[2].name === 'salt-crystal' with hitboxShrink 0.20, placement 'floating', floatHeight 120
5. SPAWN_BASE_INTERVAL, SPAWN_INTERVAL_VARIATION, FLOAT_UNLOCK_ELAPSED exist
6. CLUSTER_PROBABILITY, CLUSTER_SIZE_MAX, CLUSTER_GAP exist
7. PLAYER_HITBOX_SHRINK exists
8. DEATH_ANIMATION_DURATION, DEATH_FLASH_INTERVAL, DEATH_SHAKE_DURATION, SHAKE_AMPLITUDE exist
9. NEAR_MISS_FLASH_COLOR, NEAR_MISS_FLASH_DURATION exist
10. GAME_OVER_OVERLAY_ALPHA exists
11. All existing Phase 2/3 config values still present (GRAVITY, JUMP_VELOCITY, GROUND_MARKER_COLOR, COUNTDOWN_STEP, etc)
12. No import statements for collision.js, obstacle.js, or game.js
  </verify>
  <done>config.js contains full Phase 4 obstacle type definitions (3 types with hitboxShrink, placement, floatHeight, unlockAfter, spawnWeight, displayName) and all spawn timing, cluster, death animation, near-miss, and game over overlay constants. All existing config values preserved.</done>
</task>

<task type="auto">
  <name>Task 2: Implement obstacle spawning, movement, rendering, and wire into game loop</name>
  <files>js/main.js, js/renderer.js</files>
  <action>
Read the current js/main.js and js/renderer.js first -- Phase 2 and Phase 3 will have modified them significantly (player physics, five-state machine, drawGround, drawHUD, etc). Understand the current code structure before modifying.

**In js/renderer.js -- Add drawObstacles function:**

Add a new exported function `drawObstacles(ctx, obstacles)` that draws each obstacle in the array as a colored rectangle:

```javascript
export function drawObstacles(ctx, obstacles) {
  for (const obs of obstacles) {
    ctx.fillStyle = obs.color;
    ctx.fillRect(Math.round(obs.x), Math.round(obs.y), obs.width, obs.height);
  }
}
```

Use `Math.round()` on x and y for crisp pixel alignment. No other changes to renderer.js in this task.

**In js/main.js -- Add obstacle spawning system:**

Add these module-level variables (alongside existing state variables like distance, groundOffset, gameState, etc):

```javascript
// Obstacle state (Phase 4)
let obstacles = [];
let spawnTimer = 0;
let spawnInterval = CONFIG.SPAWN_BASE_INTERVAL;
let gameElapsed = 0;  // seconds since RUNNING started (for progressive unlocking)
```

Add `drawObstacles` to the existing import from './renderer.js'.

**Add helper functions** (module-level, not exported):

1. `weightedRandom(types)` -- weighted random selection from available types:
```javascript
function weightedRandom(types) {
  const total = types.reduce((sum, t) => sum + (t.spawnWeight || 1), 0);
  let rand = Math.random() * total;
  for (const type of types) {
    rand -= (type.spawnWeight || 1);
    if (rand <= 0) return type;
  }
  return types[types.length - 1];
}
```

2. `createObstacle(type, xOverride)` -- creates an obstacle object at a given X position (or default just off-screen right):
```javascript
function createObstacle(type, xOverride) {
  const isFloat = type.placement === 'floating';
  const visualY = isFloat
    ? CONFIG.GROUND_Y - type.height - type.floatHeight
    : CONFIG.GROUND_Y - type.height;

  return {
    type: type.name,
    displayName: type.displayName,
    x: xOverride !== undefined ? xOverride : CONFIG.CANVAS_WIDTH + type.width + 10,
    y: visualY,
    width: type.width,
    height: type.height,
    color: type.color,
    hitboxShrink: type.hitboxShrink,
  };
}
```

Note: spawn X is `CANVAS_WIDTH + type.width + 10` (not just CANVAS_WIDTH) to ensure full clearance before any collision check. The `xOverride` param is used for cluster members at staggered positions.

3. `updateSpawning(deltaTime)` -- delta-time accumulator with progressive type introduction and clusters:
```javascript
function updateSpawning(deltaTime) {
  gameElapsed += deltaTime;
  spawnTimer += deltaTime;

  if (spawnTimer >= spawnInterval) {
    spawnTimer -= spawnInterval;  // preserve remainder -- critical for accuracy

    // Filter to unlocked types; ground-only until FLOAT_UNLOCK_ELAPSED
    const availableTypes = CONFIG.OBSTACLE_TYPES.filter(t => {
      if ((t.unlockAfter || 0) > gameElapsed) return false;
      if (t.placement === 'floating' && gameElapsed < CONFIG.FLOAT_UNLOCK_ELAPSED) return false;
      return true;
    });

    if (availableTypes.length > 0) {
      const type = weightedRandom(availableTypes);
      obstacles.push(createObstacle(type));

      // Cluster: with CLUSTER_PROBABILITY, spawn 1-2 more at staggered X positions
      if (Math.random() < CONFIG.CLUSTER_PROBABILITY) {
        const clusterSize = 1 + Math.floor(Math.random() * (CONFIG.CLUSTER_SIZE_MAX - 1));
        for (let i = 0; i < clusterSize; i++) {
          const extraType = weightedRandom(availableTypes);
          const clusterX = CONFIG.CANVAS_WIDTH + (i + 1) * CONFIG.CLUSTER_GAP + extraType.width + 10;
          obstacles.push(createObstacle(extraType, clusterX));
        }
      }
    }

    // Vary next spawn interval
    const variation = (Math.random() - 0.5) * 2 * CONFIG.SPAWN_INTERVAL_VARIATION;
    spawnInterval = Math.max(0.8, CONFIG.SPAWN_BASE_INTERVAL + variation);
  }
}
```

4. `updateObstacles(deltaTime)` -- move obstacles left and remove off-screen ones:
```javascript
function updateObstacles(deltaTime) {
  const speed = CONFIG.GAME_SPEED;
  for (const obs of obstacles) {
    obs.x -= speed * deltaTime;
  }
  obstacles = obstacles.filter(obs => obs.x + obs.width > 0);
}
```

**Wire into the game loop:**

In the RUNNING state branch of the game loop, add calls to the spawn and update functions. Place them AFTER the existing distance update and BEFORE drawing:

```javascript
// In RUNNING state block:
updateSpawning(deltaTime);
updateObstacles(deltaTime);
```

Draw obstacles AFTER the ground and BEFORE the player (so obstacles appear behind the player, which is the standard runner convention):

```javascript
// In RUNNING state render section:
drawObstacles(ctx, obstacles);
// drawPlayer(ctx, player, CONFIG); -- already exists from Phase 2
```

Also draw obstacles in PAUSED, DYING, and GAME_OVER states (frozen in place, no update):

```javascript
// In PAUSED state render section (after drawGround, before drawPauseOverlay):
drawObstacles(ctx, obstacles);

// In GAME_OVER state render section (after drawGround):
drawObstacles(ctx, obstacles);
```

**Extend resetGame():**

Add obstacle reset to the existing resetGame function. The function already resets distance, groundOffset, gameState, and player (from Phase 2/3). Add:

```javascript
obstacles = [];
spawnTimer = 0;
spawnInterval = CONFIG.SPAWN_BASE_INTERVAL;
gameElapsed = 0;
```

IMPORTANT: Only call updateSpawning and updateObstacles when `gameState === 'RUNNING'`. Do NOT update obstacles during COUNTDOWN, PAUSED, DYING, or GAME_OVER (obstacles freeze).

IMPORTANT: Do NOT import from or reference the legacy js/collision.js, js/obstacle.js, or js/game.js files. They are incompatible with this codebase.

IMPORTANT: Do NOT implement collision detection in this plan. That is Plan 02. Obstacles should spawn, move, and pass through the player harmlessly in this plan.
  </action>
  <verify>
Read js/main.js and confirm:
1. Contains `let obstacles = []` and `let spawnTimer = 0` and `let gameElapsed = 0`
2. Contains `weightedRandom`, `createObstacle`, `updateSpawning`, `updateObstacles` functions
3. `createObstacle` uses `CONFIG.CANVAS_WIDTH + type.width + 10` for default X position
4. `updateSpawning` filters by `unlockAfter` and `FLOAT_UNLOCK_ELAPSED`
5. `updateSpawning` uses `spawnTimer -= spawnInterval` (not `spawnTimer = 0`)
6. `updateSpawning` includes cluster spawning with `CONFIG.CLUSTER_PROBABILITY`
7. RUNNING state calls `updateSpawning(deltaTime)` and `updateObstacles(deltaTime)`
8. PAUSED and GAME_OVER states draw obstacles but do NOT update them
9. `resetGame` clears obstacles array and resets spawn timers and gameElapsed
10. `drawObstacles` imported from renderer.js
11. No imports from collision.js, obstacle.js, or game.js

Read js/renderer.js and confirm:
1. Contains `export function drawObstacles(ctx, obstacles)`
2. drawObstacles iterates the array and draws fillRect for each obstacle
3. Uses Math.round on x and y positions

Open index.html in browser:
1. Start the game (Space through countdown)
2. After a few seconds, brown rectangles (kidney stones) should appear from the right and scroll left
3. After ~10 seconds, green rectangles (toxins) should start appearing
4. After ~20 seconds, light-blue rectangles (salt crystals) should appear floating above ground level
5. Occasional clusters of 2-3 obstacles visible
6. Obstacles pass through the player (no collision yet)
7. Pressing Escape pauses -- obstacles freeze in place
8. No console errors
  </verify>
  <done>Obstacles spawn from the right edge with progressive type introduction (stones first, toxins at 10s, salt crystals at 20s), scroll left at GAME_SPEED, appear as colored rectangles, cluster occasionally, and freeze during pause/game-over. Spawn timing uses delta-time accumulator with remainder preservation. Off-screen obstacles removed via filter. resetGame clears all obstacle state.</done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Open index.html in browser, start the game
2. Brown kidney stone rectangles spawn and scroll left within the first few seconds
3. Green toxin rectangles begin appearing after ~10 seconds
4. Light-blue salt crystal rectangles appear floating above ground after ~20 seconds
5. Occasional clusters of 2-3 obstacles visible
6. Obstacles are colored rectangles (no sprites -- POC phase)
7. Pause freezes obstacles in place; resume continues them
8. Restarting clears all obstacles
9. CONFIG.SPAWN_BASE_INTERVAL = 0.5 in console makes spawning faster
10. CONFIG.OBSTACLE_TYPES[2].unlockAfter = 0 makes salt crystals appear immediately
11. No console errors
</verification>

<success_criteria>
1. Three obstacle types visible as colored rectangles with distinct colors
2. Progressive type introduction works (stones -> toxins -> salt crystals over time)
3. Floating salt crystals positioned above ground level
4. Spawn timing feels rhythmic with random variation (not metronome-regular, not chaotic)
5. Cluster spawning produces occasional 2-3 obstacle groups
6. Obstacles freeze during PAUSED and GAME_OVER states
7. All spawn/timing values tunable via CONFIG in browser console
8. No collision detection yet -- obstacles pass through player harmlessly
</success_criteria>

<output>
After completion, create `.planning/phases/04-obstacles-collision/04-01-SUMMARY.md`
</output>
