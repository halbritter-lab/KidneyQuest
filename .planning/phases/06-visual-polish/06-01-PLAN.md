---
phase: 06-visual-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - js/sprites.js
  - js/particles.js
  - js/player.js
  - css/style.css
autonomous: true

must_haves:
  truths:
    - "Sprite loader module exists and exports loadSprites() and SPRITES object"
    - "Particle pool module exists and exports createParticlePool, emitParticles, updateParticles, drawParticles"
    - "Player has a death animation state that freezes all other state transitions"
    - "Canvas renders pixel art crisply without bilinear smoothing"
  artifacts:
    - path: "js/sprites.js"
      provides: "Image loader with decode() + fallback"
      exports: ["loadSprites", "SPRITES"]
    - path: "js/particles.js"
      provides: "Particle pool factory for burst effects"
      exports: ["createParticlePool", "emitParticles", "updateParticles", "drawParticles"]
    - path: "js/player.js"
      provides: "death ANIM_STATE + frozen flag"
      contains: "death"
    - path: "css/style.css"
      provides: "Pixel art rendering CSS"
      contains: "image-rendering"
  key_links:
    - from: "js/sprites.js"
      to: "assets/sprites/"
      via: "Image src paths"
      pattern: "assets/sprites/"
    - from: "js/player.js"
      to: "ANIM_STATES.death"
      via: "frozen flag bypasses updateAnimState"
      pattern: "frozen"
---

<objective>
Create the infrastructure modules that all other Phase 6 plans depend on: a sprite sheet loader (`sprites.js`), a particle pool system (`particles.js`), extend the player with a death animation state, and add CSS for crisp pixel art rendering.

Purpose: These are the foundational building blocks. Sprite loading must exist before any sprite-based rendering. Particles must exist before collection/death effects. The death state must exist before death animations. Pixel art CSS must be set before sprites render.

Output: Two new JS modules (`sprites.js`, `particles.js`), extended `player.js`, and updated `style.css`.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-visual-polish/06-CONTEXT.md
@.planning/phases/06-visual-polish/06-RESEARCH.md
@js/player.js
@css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sprites.js loader and particles.js pool modules</name>
  <files>js/sprites.js, js/particles.js</files>
  <action>
Create `js/sprites.js` -- sprite sheet image loader:
- Define SPRITE_PATHS object mapping keys to file paths:
  - zebra: 'assets/sprites/zebra-sheet.png'
  - obstacles: 'assets/sprites/obstacles.png'
  - genes: 'assets/sprites/genes.png'
  - bgMid: 'assets/sprites/bg-mid.png'
  - bgNear: 'assets/sprites/bg-near.png'
- Export `SPRITES` object with same keys, all initially `null`
- Export `async function loadSprites()` that:
  - Uses `Promise.all` to load all images concurrently
  - For each entry: creates `new Image()`, sets `img.src`, calls `await img.decode()`
  - On success: sets `SPRITES[key] = img`
  - On failure (catch): logs `console.warn('[sprites] Failed to load ${path} -- using procedural fallback')` and leaves `SPRITES[key]` as `null`
  - Returns void (callers check SPRITES[key] !== null before using)
- Use factory function style with named exports (consistent with project conventions)
- Add JSDoc comments explaining the module purpose and each export

Create `js/particles.js` -- particle pool system:
- Export `createParticlePool(maxCount = 50)` -- returns an array of `maxCount` particle objects, each `{ active: false }`
- Export `emitParticles(pool, x, y, color, count = 8)` -- activates `count` inactive particles at position (x, y):
  - Spread particles in a radial burst (angle = 2*PI * i / count)
  - Speed: 80 + Math.random() * 120
  - Slight upward bias: vy -= 60
  - maxLife: 0.5 + Math.random() * 0.3 seconds
  - radius: 3 + Math.random() * 4
  - Store color on each particle
- Export `updateParticles(pool, deltaTime)` -- for each active particle:
  - Advance life by deltaTime
  - Deactivate if life >= maxLife
  - Move x by vx * deltaTime
  - Move y by (vy + 120 * life) * deltaTime (gravity pull on particles)
- Export `drawParticles(ctx, pool)` -- for each active particle:
  - Calculate alpha = 1 - (life / maxLife) for fade-out
  - ctx.save(), set globalAlpha, fillStyle = color
  - Draw filled arc (circle) at particle position with particle radius
  - ctx.restore()
- Use factory function pattern, JSDoc all exports
  </action>
  <verify>
Open browser dev tools console:
- `import('./js/sprites.js')` should resolve without syntax errors
- `import('./js/particles.js')` should resolve without syntax errors
- `loadSprites()` should complete (with warnings about missing PNGs since no sprites exist yet)
- `SPRITES.zebra` should be `null` (no sprite files yet -- confirms graceful fallback)
- `createParticlePool(10)` should return array of 10 objects with `{ active: false }`
  </verify>
  <done>
Both modules import cleanly with no syntax errors. loadSprites() handles missing files gracefully (warns, returns null). Particle pool creates, emits, updates, and draws without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add death animation state to player.js and pixel art CSS</name>
  <files>js/player.js, css/style.css</files>
  <action>
Extend `js/player.js`:

1. Add `death` to ANIM_STATES:
   ```
   death: { frames: 4, fps: 8, loop: false }
   ```

2. Add `frozen: false` property to the object returned by `createPlayer()`.

3. In `updateAnimState()`, add an early return at the very top (before the existing guard):
   ```javascript
   // Death freeze: when frozen, animation state is locked externally (death tumble)
   if (player.frozen) return;
   ```
   This must be BEFORE the `if (!ANIM_STATES[player.animState])` guard so that the death state is never overridden by physics-based transitions.

4. In `createPlayer()`, ensure `frozen: false` is included so `Object.assign(player, createPlayer(CONFIG))` resets it on restart.

Why the frozen flag: Without it, `updateAnimState` would immediately override `player.animState = 'death'` with 'idle' or 'fall' based on physics state. The frozen flag lets the death animation play uninterrupted.

Extend `css/style.css`:

Add `image-rendering: pixelated;` to the existing `canvas` rule. This tells the browser to use nearest-neighbor scaling instead of bilinear interpolation when the canvas CSS size differs from its internal pixel dimensions. Critical for crisp pixel art sprites at the game's 2x DPI scale.

The canvas rule should become:
```css
canvas {
  display: block;
  touch-action: none;
  outline: none;
  image-rendering: pixelated;
}
```
  </action>
  <verify>
- Check `js/player.js`: grep for `death:` in ANIM_STATES -- should show `{ frames: 4, fps: 8, loop: false }`
- Check `js/player.js`: grep for `frozen: false` in createPlayer return object
- Check `js/player.js`: grep for `if (player.frozen) return;` at top of updateAnimState
- Check `css/style.css`: grep for `image-rendering: pixelated`
- Open game in browser: existing gameplay unchanged (death state not triggered yet, frozen defaults to false)
  </verify>
  <done>
player.js has death ANIM_STATE with 4 frames at 8fps (non-looping). createPlayer() returns frozen: false. updateAnimState() returns early when frozen is true. CSS canvas rule includes image-rendering: pixelated. Game plays identically to before (no regressions).
  </done>
</task>

</tasks>

<verification>
- `js/sprites.js` exists and exports loadSprites + SPRITES
- `js/particles.js` exists and exports createParticlePool, emitParticles, updateParticles, drawParticles
- `js/player.js` ANIM_STATES includes death with frames: 4, fps: 8, loop: false
- `js/player.js` createPlayer returns frozen: false
- `js/player.js` updateAnimState returns early when player.frozen is true
- `css/style.css` canvas rule includes image-rendering: pixelated
- Game runs without errors in browser (no regressions)
</verification>

<success_criteria>
- Two new modules (sprites.js, particles.js) importable without errors
- loadSprites() gracefully handles missing PNG files
- Particle pool creates, emits, updates, and draws correctly
- Player death state is a valid ANIM_STATE
- Frozen flag prevents updateAnimState from overriding death
- Pixel art CSS applied to canvas
- Existing gameplay unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/06-visual-polish/06-01-SUMMARY.md`
</output>
