---
phase: 06-visual-polish
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - js/main.js
  - js/renderer.js
autonomous: true

must_haves:
  truths:
    - "Parallax background renders behind all game entities during gameplay"
    - "Screen shakes briefly on death/collision"
    - "Particle burst plays on gene collection and death"
    - "Start screen shows KidneyQuest title with pixel art style and tagline"
    - "Game over screen shows score breakdown with distance + genes collected"
  artifacts:
    - path: "js/main.js"
      provides: "Full visual polish wiring"
      contains: "createBackground"
    - path: "js/renderer.js"
      provides: "Polished start and game over screens"
      contains: "drawPixelTitle"
  key_links:
    - from: "js/main.js"
      to: "js/background.js"
      via: "import createBackground"
      pattern: "import.*createBackground"
    - from: "js/main.js"
      to: "js/particles.js"
      via: "import particle functions"
      pattern: "import.*emitParticles"
    - from: "js/main.js"
      to: "js/sprites.js"
      via: "loadSprites before game loop"
      pattern: "loadSprites"
    - from: "js/main.js"
      to: "ctx.translate for shake"
      via: "screen shake in render loop"
      pattern: "shakeIntensity"
    - from: "js/renderer.js"
      to: "drawPixelTitle"
      via: "start screen rendering"
      pattern: "KidneyQuest"
---

<objective>
Wire all Phase 6 visual systems into `main.js` (parallax background, screen shake, particle effects, sprite loading) and polish the start screen and game over screen in `renderer.js`. This is the integration plan that brings everything together.

Purpose: Plans 01-03 created the building blocks. This plan connects them into the game loop, replaces the placeholder start/game-over screens with polished versions, and adds screen shake + particle effects. After this plan, the visual polish is complete.

Output: Fully wired `main.js` with all visual systems active. Polished start and game over screens.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-visual-polish/06-CONTEXT.md
@.planning/phases/06-visual-polish/06-RESEARCH.md
@.planning/phases/06-visual-polish/06-01-SUMMARY.md
@.planning/phases/06-visual-polish/06-02-SUMMARY.md
@.planning/phases/06-visual-polish/06-03-SUMMARY.md
@js/main.js
@js/renderer.js
@js/background.js
@js/sprites.js
@js/particles.js
@js/config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire parallax background, screen shake, particles, and sprite loading into main.js</name>
  <files>js/main.js</files>
  <action>
**New imports at top of main.js:**
```javascript
import { createBackground } from './background.js';
import { loadSprites } from './sprites.js';
import { createParticlePool, emitParticles, updateParticles, drawParticles } from './particles.js';
```

**New module-level state (after existing state variables):**
```javascript
// Parallax background
const background = createBackground();

// Effect particles (gene collection bursts, death particles)
const effectParticles = createParticlePool(60);

// Screen shake state
let shakeIntensity = 0;
let shakeDuration = 0;
const SHAKE_DECAY_RATE = 8;
```

**Screen shake helper functions (near state transition helpers):**
```javascript
function startShake(intensity, duration) {
  shakeIntensity = intensity;
  shakeDuration = duration;
}

function applyShake(ctx, deltaTime) {
  if (shakeDuration <= 0) return;
  shakeDuration -= deltaTime;
  const decay = Math.max(0, shakeDuration / 0.4);
  const magnitude = shakeIntensity * decay;
  const dx = (Math.random() * 2 - 1) * magnitude;
  const dy = (Math.random() * 2 - 1) * magnitude;
  ctx.translate(dx, dy);
}
```

**Modify triggerGameOver():**
- Add screen shake: `startShake(CONFIG.SHAKE_AMPLITUDE, CONFIG.DEATH_SHAKE_DURATION);`
- Add death particles: `emitParticles(effectParticles, player.x + CONFIG.PLAYER_WIDTH/2, player.y + CONFIG.PLAYER_HEIGHT/2, '#FF4444', 12);`
- Set player death state: `player.frozen = true; player.animState = 'death'; player.animFrame = 0; player.animTime = 0;`

**Modify resetGame():**
- Add: `shakeIntensity = 0; shakeDuration = 0;`
- The existing `Object.assign(player, createPlayer(CONFIG))` already resets `frozen: false`

**Modify the game loop render section:**
After `clearCanvas(ctx, CONFIG);`, BEFORE drawing the ground/entities:

1. Update background: In READY/COUNTDOWN states, call `background.update(CONFIG.READY_SCROLL_SPEED, deltaTime)`. In RUNNING state, call `background.update(CONFIG.GAME_SPEED, deltaTime)`. In PAUSED/GAME_OVER, skip update (background freezes).

2. Draw background: Call `background.draw(ctx)` in ALL states (always visible). This replaces the `clearCanvas` as the visual base -- but keep `clearCanvas` as it clears the previous frame. The background draws on top of the cleared canvas, then entities draw on top of the background.

3. Wrap the entire entity rendering section in screen shake:
   ```javascript
   ctx.save();
   applyShake(ctx, deltaTime);
   // ... all entity drawing (ground, obstacles, player, genes, HUD) ...
   // ... draw particles ...
   drawParticles(ctx, effectParticles);
   ctx.restore();
   ```

4. Update effect particles: `updateParticles(effectParticles, deltaTime)` in RUNNING and GAME_OVER states.

**Modify sprite loading at startup:**
The game currently kicks off with `requestAnimationFrame(gameLoop)` at the bottom. Change to:
```javascript
// Load sprites (non-blocking -- game starts with procedural fallback if sprites missing)
loadSprites().then(() => {
  console.log('[main] Sprites loaded (or fallback active)');
});

// Set imageSmoothingEnabled once after canvas setup
ctx.imageSmoothingEnabled = false;

// Kick off the loop
requestAnimationFrame(gameLoop);
```
Note: The game loop starts immediately without waiting for sprites. loadSprites runs in parallel. When sprites load, SPRITES object updates and the next frame draws sprites. This prevents a blank screen while waiting for images.

**Modify renderStartScreen():**
Replace the inline start screen rendering with a call to the polished version from renderer.js:
```javascript
function renderStartScreen(ctx, timestamp) {
  drawStartScreen(ctx, CONFIG, timestamp);
}
```
Add `drawStartScreen` to the import list from renderer.js.

**Wire drawGenes into the game loop:**
In the RUNNING state render section, after `drawObstacles` and before `drawPlayer`:
- If a genes array exists (it will be added in Phase 5), call `drawGenes(ctx, genes)`
- For now, import `drawGenes` from renderer.js and add a comment placeholder: `// drawGenes(ctx, genes); -- wired when Phase 5 collectible array exists`

**Update the __game debug object** to include background and particles for workshop debugging:
```javascript
get background() { return background; },
get effectParticles() { return effectParticles; },
```

**Important ordering in game loop:**
1. clearCanvas
2. background.update (if state allows)
3. background.draw
4. drawGround (on top of background -- ground is still managed by renderer.js)
5. ctx.save() + applyShake
6. Draw entities (obstacles, genes, player)
7. drawParticles(ctx, effectParticles)
8. ctx.restore() (removes shake)
9. Draw HUD (outside shake -- HUD should NOT shake)
10. Draw overlays (countdown, pause, game over -- outside shake)
  </action>
  <verify>
1. Open game in browser:
   - Start screen should show warm parallax background with floating particles
   - Ground still renders with scrolling markers on top of the background
   - During gameplay, background layers scroll at different speeds (parallax visible)
   - On game over (if collision implemented), screen should shake briefly and red particles burst

2. Check console:
   - Should see '[main] Sprites loaded (or fallback active)'
   - Should see sprite loading warnings (PNGs don't exist yet)
   - No errors

3. Check browser DevTools performance:
   - Frame rate should stay above 55fps with 5 background layers
  </verify>
  <done>
main.js imports and wires: parallax background (updates per state, draws every frame), screen shake (triggers on game over), effect particles (burst on death), sprite loading (non-blocking). Game loop order: clear -> background -> ground -> shake wrapper -> entities -> particles -> restore -> HUD -> overlays. Background renders warm kidney-interior gradient with floating particles. Screen shake produces visible camera displacement on death.
  </done>
</task>

<task type="auto">
  <name>Task 2: Polish start screen and game over screen in renderer.js</name>
  <files>js/renderer.js</files>
  <action>
**New exported function: drawStartScreen(ctx, config, timestamp)**

Replace the old inline start screen rendering (which was in main.js renderStartScreen) with a polished version in renderer.js:

1. Draw a semi-transparent dark overlay over the background for readability: `ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(0, 0, config.CANVAS_WIDTH, config.CANVAS_HEIGHT);`

2. Draw "KidneyQuest" title using pixel art style:
   - Create a helper function `drawPixelTitle(ctx, text, x, y, size, fillColor, strokeColor)`:
     - ctx.save()
     - ctx.font = `bold ${size}px monospace`
     - ctx.textAlign = 'center'
     - ctx.textBaseline = 'middle'
     - Draw dark outline: ctx.strokeStyle = strokeColor || '#111111', ctx.lineWidth = size * 0.08, ctx.strokeText
     - Draw fill: ctx.fillStyle = fillColor, ctx.fillText
     - ctx.restore()
   - Call with: text='KidneyQuest', x=center, y=35% height, size=64, fillColor='#FFD700' (gold)

3. Draw "Collect the Genes!" tagline:
   - Use drawPixelTitle with smaller size (28px), white color, at 48% height

4. Draw zebra hero shot:
   - If SPRITES.zebra is available: draw idle frame 0 at center, scaled up 2x (128x160px), at 60% height
   - If not: draw the procedural zebra at that position using drawZebraFrame
   - Set ctx.imageSmoothingEnabled = false for crisp pixel scaling

5. Draw "Press Space to Start" with existing pulsing alpha:
   - Same oscillation formula: `alpha = 0.3 + 0.7 * Math.abs(Math.sin(timestamp / 500))`
   - Position at 82% height
   - Use drawText with alpha

**Modify drawGameOver(ctx, config, gameOverTimer):**

Keep the existing phase timing (Phase 1: silent flash, Phase 2: text appears, Phase 3: restart prompt). Enhance the visuals:

1. Phase 2+: Add semi-transparent dark overlay for readability (same as start screen)

2. Phase 2+: "Game Over" text -- use drawPixelTitle style with red color (#FF4444), larger size (72px), dark outline

3. Phase 2+: Score breakdown below "Game Over":
   - Add two new parameters to drawGameOver: `distance` and `genesCollected` (default 0 for backward compat)
   - Distance score: `Math.floor(distance / config.PX_PER_METER)` meters
   - Genes collected: `genesCollected` count (will be wired when Phase 5 is complete)
   - Total: `Math.floor(distance / config.PX_PER_METER) + (genesCollected * 10)` -- simplified scoring
   - Draw each line:
     - "Distance: {N}m" at cy + 30, white, 24px
     - "Genes: {N}" at cy + 60, white, 24px
     - "Score: {total}" at cy + 100, gold (#FFD700), bold 32px

4. Phase 3: Pulsing "Press Space to Retry" (changed from "Press Space to restart" for better game feel):
   - Same pulse formula, position at cy + 150

**Update drawGameOver call signature:**
The function now accepts `(ctx, config, gameOverTimer, distance, genesCollected)`. The last two params have defaults of 0, so existing callers (in main.js) work without changes initially.

Update the main.js drawGameOver call to pass distance:
- `drawGameOver(ctx, CONFIG, gameOverTimer, distance, 0)` (genes collected will be wired in Phase 5)

This means main.js is also touched in this task (updating the drawGameOver call). Since Task 1 already modifies main.js, this is a small addition to the same file.

**Update renderer.js exports:**
Add `drawStartScreen` to the named exports.
Update the import in main.js to include `drawStartScreen`.

**VIZP-07 override:** Per CONTEXT.md, the start screen shows "KidneyQuest" title + "Collect the Genes!" tagline instead of CeRKiD branding. This is the locked override.

**VIZP-08:** Game over screen shows score breakdown (distance + genes). Best score display is deferred (requires localStorage, which is out of scope per CONTEXT.md deferred list).
  </action>
  <verify>
1. Open game in browser:
   - Start screen shows warm parallax background with dark overlay
   - "KidneyQuest" rendered in large gold pixel art style font with dark outline
   - "Collect the Genes!" tagline visible below title
   - Zebra hero shot visible (procedural or sprite-based)
   - "Press Space to Start" pulsing at bottom

2. Trigger game over (via window.triggerGameOver() in console if collision not yet wired):
   - Dark overlay appears after flash phase
   - "Game Over" in red pixel art style
   - Score breakdown shows distance in meters
   - "Press Space to Retry" pulses after cooldown

3. No console errors
  </verify>
  <done>
Start screen displays KidneyQuest title in pixel art style, tagline "Collect the Genes!", zebra hero shot, and pulsing start prompt -- all on top of parallax background with readability overlay. Game over screen shows "Game Over" in styled red text, score breakdown (distance + genes placeholder), and pulsing retry prompt. VIZP-07 (overridden: KidneyQuest branding, no CeRKiD) and VIZP-08 (score breakdown) requirements addressed.
  </done>
</task>

</tasks>

<verification>
- main.js imports and initializes: createBackground, loadSprites, particle pool
- Background renders in all game states (warm parallax gradient visible)
- Background updates only in READY/COUNTDOWN/RUNNING (freezes in PAUSED/GAME_OVER)
- Screen shake triggers on game over with CONFIG.SHAKE_AMPLITUDE intensity
- Death particles burst from player position on game over
- Player enters death animation state (frozen = true) on game over
- HUD renders outside shake wrapper (doesn't jiggle)
- Start screen: "KidneyQuest" gold title, "Collect the Genes!" tagline, zebra hero, pulsing prompt
- Game over screen: styled "Game Over", score breakdown, pulsing "Press Space to Retry"
- Sprites load non-blocking (game starts immediately with procedural fallback)
- ctx.imageSmoothingEnabled = false set after canvas setup
- No console errors, frame rate above 55fps
</verification>

<success_criteria>
- Parallax background visible and scrolling at different speeds per layer (VIZP-06)
- Start screen shows KidneyQuest title + tagline (VIZP-07 override honored)
- Game over screen shows score breakdown (VIZP-08)
- Screen shake on death is visible and brief
- Particle burst on death is visible
- Game runs without errors with all systems wired
- Procedural fallback still works when sprite PNGs are missing
</success_criteria>

<output>
After completion, create `.planning/phases/06-visual-polish/06-04-SUMMARY.md`
</output>
