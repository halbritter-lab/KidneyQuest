---
phase: 06-visual-polish
plan: 04
type: execute
wave: 3
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - js/main.js
  - js/renderer.js
autonomous: true

must_haves:
  truths:
    - "Parallax background renders behind all game entities during gameplay"
    - "Screen shakes on death using the existing DYING state and drawWithShake system"
    - "Particle burst plays on death"
    - "Start screen shows KidneyQuest title with pixel art style and tagline"
    - "Game over screen shows score breakdown with distance + genes collected + best score"
    - "Gene glow effect is callable from the game loop when genes array exists"
  artifacts:
    - path: "js/main.js"
      provides: "Full visual polish wiring"
      contains: "createBackground"
    - path: "js/renderer.js"
      provides: "Polished start and game over screens"
      contains: "drawPixelTitle"
  key_links:
    - from: "js/main.js"
      to: "js/background.js"
      via: "import createBackground"
      pattern: "import.*createBackground"
    - from: "js/main.js"
      to: "js/particles.js"
      via: "import particle functions"
      pattern: "import.*emitParticles"
    - from: "js/main.js"
      to: "js/sprites.js"
      via: "loadSprites before game loop"
      pattern: "loadSprites"
    - from: "js/main.js"
      to: "triggerDeath"
      via: "particle emit and frozen flag set during DYING state"
      pattern: "emitParticles.*triggerDeath|triggerDeath.*emitParticles"
    - from: "js/main.js"
      to: "drawGenes"
      via: "conditional call in RUNNING state render"
      pattern: "drawGenes"
    - from: "js/renderer.js"
      to: "drawStartScreen"
      via: "start screen rendering"
      pattern: "KidneyQuest"
    - from: "js/renderer.js"
      to: "drawGameOver"
      via: "score breakdown with bestScore"
      pattern: "bestScore"
---

<objective>
Wire all Phase 6 visual systems into `main.js` (parallax background, particle effects, sprite loading) and polish the start screen and game over screen in `renderer.js`. This is the integration plan that brings everything together.

Purpose: Plans 01-03 created the building blocks. This plan connects them into the game loop, replaces the placeholder start/game-over screens with polished versions, and adds particle effects during the existing DYING state. After this plan, the visual polish is complete.

Output: Fully wired `main.js` with all visual systems active. Polished start and game over screens.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-visual-polish/06-CONTEXT.md
@.planning/phases/06-visual-polish/06-RESEARCH.md
@.planning/phases/06-visual-polish/06-01-SUMMARY.md
@.planning/phases/06-visual-polish/06-02-SUMMARY.md
@.planning/phases/06-visual-polish/06-03-SUMMARY.md
@js/main.js
@js/renderer.js
@js/background.js
@js/sprites.js
@js/particles.js
@js/config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire parallax background, particles, sprite loading, and drawGenes into main.js</name>
  <files>js/main.js</files>
  <action>
**IMPORTANT: The existing main.js has a DYING game state with triggerDeath(obstacle), deathTimer, drawWithShake(), and killerObstacleName. Do NOT add a second shake system. Do NOT add a separate triggerGameOver-based shake. Wire all new visual effects INTO the existing DYING state flow.**

**New imports at top of main.js:**
```javascript
import { createBackground } from './background.js';
import { loadSprites } from './sprites.js';
import { createParticlePool, emitParticles, updateParticles, drawParticles } from './particles.js';
import { drawGenes } from './renderer.js';  // add drawGenes to the existing renderer import
```

Update the existing renderer.js import to also include `drawStartScreen` and `drawGenes`:
```javascript
import {
  setupCanvas, resizeCanvas, clearCanvas, drawText,
  drawGround, drawPlayer, drawObstacles, drawGenes, drawStartScreen,
  drawCountdown, drawPauseOverlay, drawGameOver, drawHUD,
  drawWithShake,
} from './renderer.js';
```

**New module-level state (after existing state variables):**
```javascript
// Parallax background
const background = createBackground();

// Effect particles (death particles, gene collection bursts)
const effectParticles = createParticlePool(60);

// In-session best score tracking (module-level, NOT localStorage)
let bestDistance = 0;
```

**Modify triggerDeath(obstacle) -- NOT triggerGameOver:**
The existing triggerDeath() sets gameState to 'DYING' and records killerObstacleName. Add visual effects here:
```javascript
function triggerDeath(obstacle) {
  deathTimer = 0;
  killerObstacleName = obstacle.displayName;
  gameState = 'DYING';

  // Visual polish: freeze player in death animation
  player.frozen = true;
  player.animState = 'death';
  player.animFrame = 0;
  player.animTime = 0;

  // Visual polish: burst red particles from player center
  emitParticles(
    effectParticles,
    player.x + CONFIG.PLAYER_WIDTH / 2,
    player.y + CONFIG.PLAYER_HEIGHT / 2,
    '#FF4444',
    12
  );
}
```

**Modify resetGame():**
Add particle and best score handling:
```javascript
function resetGame() {
  // Track best distance before resetting (in-session only, no localStorage)
  const currentMeters = Math.floor(distance / CONFIG.PX_PER_METER);
  if (currentMeters > bestDistance) {
    bestDistance = currentMeters;
  }

  distance = 0;
  groundOffset = 0;
  Object.assign(player, createPlayer(CONFIG));  // resets frozen: false
  obstacles = [];
  spawnTimer = 0;
  spawnInterval = CONFIG.SPAWN_BASE_INTERVAL;
  gameElapsed = 0;
  deathTimer = 0;
  killerObstacleName = null;
  nearMissTimer = 0;
  gameState = 'READY';
}
```

**Modify the game loop render section:**
After `clearCanvas(ctx, CONFIG);`, BEFORE drawing the ground/entities:

1. Update background: In READY/COUNTDOWN states, call `background.update(CONFIG.READY_SCROLL_SPEED, deltaTime)`. In RUNNING state, call `background.update(CONFIG.GAME_SPEED, deltaTime)`. In PAUSED/DYING/GAME_OVER, skip update (background freezes).

2. Draw background: Call `background.draw(ctx)` in ALL states (always visible). This draws on top of the cleared canvas, then entities draw on top of the background.

3. Update effect particles: `updateParticles(effectParticles, deltaTime)` in RUNNING, DYING, and GAME_OVER states (so death particles animate through the death sequence).

4. In the DYING state render block, the existing `drawWithShake` callback already draws ground, obstacles, and player. Add `drawParticles(ctx, effectParticles)` INSIDE the drawWithShake callback so particles shake with everything else:
```javascript
drawWithShake(ctx, CONFIG, deathTimer, () => {
  drawGround(ctx, CONFIG, groundOffset);
  drawObstacles(ctx, obstacles);

  const flashVisible = Math.floor(deathTimer / CONFIG.DEATH_FLASH_INTERVAL) % 2 === 0;
  if (flashVisible) {
    drawPlayer(ctx, player, CONFIG);
  }

  drawParticles(ctx, effectParticles);  // death particles shake with scene
  drawHUD(ctx, CONFIG, distance);
});
```

5. In the RUNNING state render, after `drawObstacles(ctx, obstacles)` and before `drawPlayer(ctx, player, CONFIG)`, wire drawGenes with a guard:
```javascript
// drawGenes wired unconditionally -- guard handles missing genes array gracefully
// Phase 5 adds the genes array; until then this is a no-op
if (typeof genes !== 'undefined' && Array.isArray(genes) && genes.length) {
  drawGenes(ctx, genes);
}
```

6. Also add `drawParticles(ctx, effectParticles)` in the RUNNING state render (after drawPlayer) for any gene collection particle effects in the future.

7. In GAME_OVER state render, also draw particles (they may still be fading):
```javascript
drawParticles(ctx, effectParticles);
```

**Modify renderStartScreen():**
Replace the inline start screen rendering with a call to the polished version from renderer.js:
```javascript
function renderStartScreen(ctx, timestamp) {
  drawStartScreen(ctx, CONFIG, timestamp);
}
```

**Update the drawGameOver call in GAME_OVER state:**
The existing call is: `drawGameOver(ctx, CONFIG, gameOverTimer, killerObstacleName, distance)`
Update to pass the new params (bestDistance and genesCollected) appended AFTER existing params:
```javascript
drawGameOver(ctx, CONFIG, gameOverTimer, killerObstacleName, distance, 0, bestDistance);
```
The `0` is genesCollected placeholder (Phase 5 will wire the real value). bestDistance is the in-session best.

**Modify sprite loading at startup:**
The game currently kicks off with `requestAnimationFrame(gameLoop)` at the bottom. Change to:
```javascript
// Load sprites (non-blocking -- game starts with procedural fallback if sprites missing)
loadSprites().then(() => {
  console.log('[main] Sprites loaded (or fallback active)');
});

// Set imageSmoothingEnabled once after canvas setup
ctx.imageSmoothingEnabled = false;

// Kick off the loop
requestAnimationFrame(gameLoop);
```
Note: The game loop starts immediately without waiting for sprites. loadSprites runs in parallel. When sprites load, SPRITES object updates and the next frame draws sprites.

**Update the __game debug object** to include background and particles:
```javascript
get background() { return background; },
get effectParticles() { return effectParticles; },
get bestDistance() { return bestDistance; },
```

**Important ordering in game loop:**
1. clearCanvas
2. background.update (if state allows)
3. background.draw
4. drawGround (on top of background -- ground is still managed by renderer.js)
5. State-specific rendering (which includes drawWithShake in DYING, or direct draws in other states)
6. drawParticles in appropriate states
7. Draw HUD (outside shake for non-DYING states -- HUD should NOT shake)
8. Draw overlays (countdown, pause, game over -- outside shake)

**Key constraint: Do NOT replace or duplicate the existing drawWithShake system.** The DYING state already provides screen shake via drawWithShake in renderer.js. The particle emit in triggerDeath() creates the visual burst. Together they produce: collision -> DYING with shake + particles -> GAME_OVER with score. This preserves the existing 5-state machine exactly.
  </action>
  <verify>
1. Open game in browser:
   - Start screen should show warm parallax background with floating particles
   - Ground still renders with scrolling markers on top of the background
   - During gameplay, background layers scroll at different speeds (parallax visible)
   - On collision with obstacle, screen should shake (existing DYING state) and red particles burst from player

2. Check console:
   - Should see '[main] Sprites loaded (or fallback active)'
   - Should see sprite loading warnings (PNGs don't exist yet)
   - No errors

3. Check browser DevTools performance:
   - Frame rate should stay above 55fps with 5 background layers

4. Verify drawGenes is imported and the guard clause doesn't throw errors during RUNNING state (genes array doesn't exist yet, guard makes it a no-op)
  </verify>
  <done>
main.js imports and wires: parallax background (updates per state, draws every frame), effect particles (burst on death via triggerDeath), sprite loading (non-blocking), drawGenes (guarded for Phase 5). Visual effects integrate into existing DYING state -- triggerDeath sets player.frozen + death animState + emits particles, drawWithShake provides screen shake. Best distance tracked in module-level variable. Game loop order: clear -> background -> ground -> state rendering -> particles -> HUD -> overlays. No new shake system added; existing drawWithShake preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Polish start screen and game over screen in renderer.js</name>
  <files>js/renderer.js</files>
  <action>
**New exported function: drawStartScreen(ctx, config, timestamp)**

Replace the old inline start screen rendering (which was in main.js renderStartScreen) with a polished version in renderer.js:

1. Draw a semi-transparent dark overlay over the background for readability: `ctx.fillStyle = 'rgba(0,0,0,0.3)'; ctx.fillRect(0, 0, config.CANVAS_WIDTH, config.CANVAS_HEIGHT);`

2. Draw "KidneyQuest" title using pixel art style:
   - Create a helper function `drawPixelTitle(ctx, text, x, y, size, fillColor, strokeColor)`:
     - ctx.save()
     - ctx.font = `bold ${size}px monospace`
     - ctx.textAlign = 'center'
     - ctx.textBaseline = 'middle'
     - Draw dark outline: ctx.strokeStyle = strokeColor || '#111111', ctx.lineWidth = size * 0.08, ctx.strokeText
     - Draw fill: ctx.fillStyle = fillColor, ctx.fillText
     - ctx.restore()
   - Call with: text='KidneyQuest', x=center, y=35% height, size=64, fillColor='#FFD700' (gold)

3. Draw "Collect the Genes!" tagline:
   - Use drawPixelTitle with smaller size (28px), white color, at 48% height
   - IMPORTANT: tagline size (28px) must be visually distinct and clearly smaller than title size (64px)

4. Draw zebra hero shot:
   - If SPRITES.zebra is available: draw idle frame 0 at center, scaled up 2x (128x160px), at 60% height
   - If not: draw the procedural zebra at that position using drawZebraFrame
   - Set ctx.imageSmoothingEnabled = false for crisp pixel scaling

5. Draw "Press Space to Start" with existing pulsing alpha:
   - Same oscillation formula: `alpha = 0.3 + 0.7 * Math.abs(Math.sin(timestamp / 500))`
   - Position at 82% height
   - Use drawText with alpha

**Modify drawGameOver -- KEEP existing signature, APPEND new params:**

The existing signature is: `drawGameOver(ctx, config, gameOverTimer, killerObstacleName, distance)`

EXTEND it by appending new parameters with defaults: `drawGameOver(ctx, config, gameOverTimer, killerObstacleName, distance, genesCollected = 0, bestScore = 0)`

This preserves backward compatibility -- any existing call that passes only the original 5 args still works correctly because genesCollected and bestScore default to 0.

Keep the existing phase timing (Phase 1: silent flash, Phase 2: text appears, Phase 3: restart prompt). Enhance the visuals:

1. Phase 2+: semi-transparent dark overlay is already drawn (existing code). Keep it.

2. Phase 2+: "Game Over" text -- use drawPixelTitle style with red color (#FF4444), larger size (72px), dark outline. Replace the existing drawText call.

3. Phase 2+: Keep killerObstacleName display ("Hit a {name}!") -- this is existing functionality.

4. Phase 2+: Score breakdown below "Game Over" and killer name:
   - Distance score: `Math.floor(distance / config.PX_PER_METER)` meters
   - Genes collected: `genesCollected` count (will be wired when Phase 5 is complete)
   - Total: `Math.floor(distance / config.PX_PER_METER) + (genesCollected * 10)` -- simplified scoring
   - Best score line: `bestScore` (in-session best distance in meters, tracked by main.js module variable)
   - Draw each line:
     - "Distance: {N}m" at cy + 30, white, 24px
     - "Genes: {N}" at cy + 60, white, 24px
     - "Score: {total}" at cy + 100, gold (#FFD700), bold 32px
     - "Best: {bestScore}m" at cy + 135, '#AAC8FF' (light blue), 22px -- only shown if bestScore > 0

5. Phase 3: Pulsing "Press Space to Retry" (updated text for better game feel):
   - Same pulse formula, position at cy + 175

**Update renderer.js exports:**
Add `drawStartScreen` and `drawGenes` to the named exports.

**VIZP-07 override:** Per CONTEXT.md, the start screen shows "KidneyQuest" title + "Collect the Genes!" tagline instead of CeRKiD branding. This is the locked override.

**VIZP-08:** Game over screen shows score breakdown (distance + genes + best score). Best score uses in-session module-level variable (NOT localStorage -- no localStorage needed). This satisfies the "best score" requirement without violating the deferred localStorage decision.
  </action>
  <verify>
1. Open game in browser:
   - Start screen shows warm parallax background with dark overlay
   - "KidneyQuest" rendered in large gold pixel art style font (64px monospace) with dark outline
   - "Collect the Genes!" tagline visible below title at clearly smaller size (28px) than the title (64px)
   - Zebra hero shot visible (procedural or sprite-based)
   - "Press Space to Start" pulsing at bottom

2. Trigger game over (hit an obstacle or via console):
   - Dark overlay appears after flash phase
   - "Game Over" in red pixel art style (72px)
   - "Hit a {obstacle}!" still shown
   - Score breakdown shows distance in meters, genes count, total score
   - After playing and dying multiple times: "Best: Xm" appears showing best distance from earlier runs
   - "Press Space to Retry" pulses after cooldown

3. Verify drawGameOver signature: check that existing call with 5 args still works (genesCollected and bestScore default to 0)

4. No console errors
  </verify>
  <done>
Start screen displays KidneyQuest title in pixel art style (64px gold monospace), tagline "Collect the Genes!" at clearly smaller 28px, zebra hero shot, and pulsing start prompt -- all on top of parallax background with readability overlay. Game over screen shows "Game Over" in styled red text, killer obstacle name preserved, score breakdown (distance + genes + total + in-session best score), and pulsing retry prompt. drawGameOver signature extended with genesCollected and bestScore appended after existing params (backward compatible via defaults). VIZP-07 (KidneyQuest branding, no CeRKiD) and VIZP-08 (score breakdown with best score) fully addressed.
  </done>
</task>

</tasks>

<verification>
- main.js imports and initializes: createBackground, loadSprites, particle pool
- Background renders in all game states (warm parallax gradient visible)
- Background updates only in READY/COUNTDOWN/RUNNING (freezes in PAUSED/DYING/GAME_OVER)
- Death particles burst from player position via triggerDeath (integrated with existing DYING state)
- Screen shake uses existing drawWithShake in DYING state (no duplicate shake system)
- Player enters death animation state (frozen = true) via triggerDeath
- drawGenes wired with guard clause (no-op until Phase 5 adds genes array)
- HUD renders outside shake wrapper in non-DYING states (doesn't jiggle)
- Start screen: "KidneyQuest" gold title (64px), "Collect the Genes!" tagline (28px, visually smaller), zebra hero, pulsing prompt
- Game over screen: styled "Game Over", killer obstacle name, score breakdown with best score, pulsing "Press Space to Retry"
- drawGameOver signature: (ctx, config, gameOverTimer, killerObstacleName, distance, genesCollected=0, bestScore=0) -- backward compatible
- In-session best score tracked via module-level bestDistance variable (not localStorage)
- Sprites load non-blocking (game starts immediately with procedural fallback)
- ctx.imageSmoothingEnabled = false set after canvas setup
- No console errors, frame rate above 55fps
</verification>

<success_criteria>
- Parallax background visible and scrolling at different speeds per layer (VIZP-06)
- Start screen shows KidneyQuest title + tagline with distinct sizes (VIZP-07 override honored)
- Game over screen shows score breakdown including in-session best score (VIZP-08)
- Death particles burst on collision (integrated into existing DYING flow)
- Screen shake on death uses existing drawWithShake (no duplicate system)
- drawGenes callable from game loop with graceful guard (VIZP-05 verifiable when Phase 5 active)
- Game runs without errors with all systems wired
- Procedural fallback still works when sprite PNGs are missing
</success_criteria>

<output>
After completion, create `.planning/phases/06-visual-polish/06-04-SUMMARY.md`
</output>
