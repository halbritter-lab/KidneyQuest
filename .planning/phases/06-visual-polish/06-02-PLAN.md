---
phase: 06-visual-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - js/background.js
autonomous: true

must_haves:
  truths:
    - "Background renders a warm kidney-interior gradient instead of the old dark blue/red/orange"
    - "Background has visually distinct layers that scroll at different speeds"
    - "Floating particle-like elements drift across the background"
    - "Background uses factory function pattern consistent with project conventions"
  artifacts:
    - path: "js/background.js"
      provides: "5-layer parallax background with factory function"
      exports: ["createBackground"]
  key_links:
    - from: "js/background.js"
      to: "CONFIG"
      via: "import CONFIG from config.js"
      pattern: "import CONFIG"
    - from: "js/background.js"
      to: "ctx.createLinearGradient"
      via: "sky gradient rendering"
      pattern: "createLinearGradient"
---

<objective>
Rewrite `js/background.js` from the old class-based pattern to a factory function that renders 5 parallax layers creating a stylized kidney-interior environment. Deep layers use procedural canvas gradients. Mid/near layers use procedural organic shapes. Floating particles add biological atmosphere.

Purpose: The background is the most visually impactful change -- it transforms the game from a dark placeholder to a warm, vibrant kidney world. The B&W zebra will pop against these warm pinks and purples.

Output: Rewritten `js/background.js` with `createBackground()` factory function.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-visual-polish/06-CONTEXT.md
@.planning/phases/06-visual-polish/06-RESEARCH.md
@js/background.js
@js/config.js
@js/renderer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite background.js as 5-layer parallax factory function</name>
  <files>js/background.js</files>
  <action>
FULLY REWRITE `js/background.js`. Delete all existing code (old class-based pattern with named imports from config.js that no longer exist). Replace with:

Import `CONFIG` using default import: `import CONFIG from './config.js';`

**Constants:**
- LAYER_SPEEDS: `[0.1, 0.2, 0.4, 0.7, 1.0]` -- scroll multipliers for sky, far organic, mid tubule, near detail, ground
- Palette from RESEARCH.md (Claude's discretion):
  - Sky gradient: '#2E0D4E' (deep purple top) -> '#7B1D5A' (magenta) -> '#C44B6B' (coral rose) -> '#E06B42' (orange-coral at ground)
  - Far layer blobs: '#A63060' (bio membrane)
  - Mid layer shapes: '#D47090' (nephron tube)
  - Near layer: '#F09080' (near edge)
  - Particle color: '#FFD4E0' (particle glow, almost white-pink)
- PARTICLE_COUNT: 15 (background ambient particles -- separate from game effect particles in particles.js)

**Export `createBackground()` factory function** returning object with:
- `update(gameSpeed, deltaTime)` -- advances all 5 layer offsets and updates ambient particles
- `draw(ctx)` -- draws all layers in back-to-front order

**Layer 0 -- Sky gradient (speed 0.1x):**
- `ctx.createLinearGradient(0, 0, 0, CONFIG.GROUND_Y)`
- 4 color stops: deep purple at 0, magenta at 0.35, coral rose at 0.70, orange-coral at 1.0
- Fills rect 0,0 to CANVAS_WIDTH, GROUND_Y
- No scroll offset needed (gradient doesn't tile -- but a subtle hue shift based on offset would be a nice touch, optional)

**Layer 1 -- Far organic shapes (speed 0.2x):**
- Procedural: draw 6-8 soft ellipses/blobs at varying Y positions in the upper half
- Use semi-transparent Bio Membrane color (#A63060 at alpha 0.3)
- X positions shift by `-(offset % wrapWidth)` for seamless scroll
- Blobs defined as fixed array of `{relX, y, radiusX, radiusY}` created once in factory closure
- wrapWidth = CONFIG.CANVAS_WIDTH (so blobs wrap seamlessly)

**Layer 2 -- Mid tubule walls (speed 0.4x):**
- Procedural: draw wavy horizontal bands using sine-based curves
- Draw 2 bands at roughly 60% and 75% of GROUND_Y
- Use Nephron Tube color (#D47090 at alpha 0.4)
- Band height: ~40px, undulation via `Math.sin(x/80 + offset*0.01) * 15`
- Step through x in 4px increments, fillRect for each column

**Layer 3 -- Near detail (speed 0.7x):**
- Procedural: draw small rounded shapes (membrane bumps) along the lower portion
- Use Near Edge color (#F09080 at alpha 0.35)
- 10-12 small circles/ellipses positioned in lower 30% of the sky area
- Scroll with layer 3 offset

**Layer 4 -- Ground (speed 1.0x):**
- Do NOT draw the ground here. The ground is still drawn by `drawGround()` in `renderer.js` (called from `main.js`). This layer's offset is tracked but the drawing is handled by the existing renderer.
- This separation is important: `drawGround()` has the dash markers and surface line that were carefully tuned in Phase 3.

**Ambient particles (inside background, not the game effect pool):**
- Create 15 particles in factory closure with random positions across the sky area
- Each particle: `{x, y, radius, speed, alpha, floatPhase}`
- radius: 2-5px, speed: 10-30 px/s upward drift, alpha: 0.2-0.5
- floatPhase: random initial phase for sine-wave horizontal drift
- Update: y drifts upward slowly, x oscillates with `Math.sin(floatPhase)`, wrap when y < 0
- Draw: filled circles with Particle Glow color at particle alpha

**Parallax offset modulo wrapping:**
- Apply `offsets[i] = offsets[i] % wrapWidth` each frame to prevent float precision loss
- wrapWidth = CONFIG.CANVAS_WIDTH for procedural layers (they tile at canvas width)

**Anti-patterns to avoid (from RESEARCH.md):**
- Do NOT use the old class pattern (`class Background`)
- Do NOT import named exports from config.js (use `import CONFIG from './config.js'`)
- Do NOT draw the ground in this module (ground is in renderer.js)
- Apply modulo wrapping to prevent float precision loss at large offsets

**Code style:** Match project conventions -- JSDoc on all functions, factory function returning plain object, consistent with player.js/renderer.js style.
  </action>
  <verify>
1. Open `js/background.js` and verify:
   - Uses `import CONFIG from './config.js'` (not named imports)
   - Exports `createBackground` (not a class)
   - Contains 5 layer speed multipliers
   - Contains warm palette hex colors (#2E0D4E, #7B1D5A, #C44B6B, #E06B42)
   - Contains ambient particle logic
   - Does NOT contain `drawGround` or ground rendering code

2. The module should be importable without errors:
   - `import { createBackground } from './background.js'` should work
   - `const bg = createBackground()` should return object with update() and draw()
   - No console errors

3. Since background.js is not yet wired into main.js (that happens in Plan 04), the game should still run with the existing drawGround from renderer.js.
  </verify>
  <done>
background.js is fully rewritten as a factory function with 5 parallax layers using warm kidney-interior palette. Ambient particles drift through layers. Module uses correct import pattern and is ready to be wired into main.js. Old class-based code is completely replaced. Game continues to run without errors (background not yet wired).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create assets directory structure with placeholder documentation</name>
  <files>assets/sprites/.gitkeep</files>
  <action>
Create the `assets/sprites/` directory that sprites.js references.

Create `assets/sprites/.gitkeep` (empty file) so the directory is tracked by Git.

This directory will eventually contain:
- zebra-sheet.png (horizontal strip, ~20 frames at 64x80px each)
- obstacles.png (kidney stone, toxin, salt crystal sprites)
- genes.png (PKD1, PKD2, COL4A5, NPHS1, NPHS2, WT1 sprites)
- bg-mid.png (tileable organic tube wall strip, ~200x60px)
- bg-near.png (tileable near detail strip, ~300x40px)

The actual PNG files are generated externally (PixelLab/Aseprite per CONTEXT.md decision). The code in sprites.js already handles missing files gracefully (returns null, uses procedural fallback).

No README file in assets/ -- just the .gitkeep to track the directory.
  </action>
  <verify>
- `assets/sprites/.gitkeep` exists
- Directory is ready for PNG files to be dropped in
  </verify>
  <done>
assets/sprites/ directory exists and is tracked by Git via .gitkeep. Ready for externally generated sprite PNG files.
  </done>
</task>

</tasks>

<verification>
- `js/background.js` exports createBackground factory function (not class)
- Background uses warm kidney-interior palette (purples, pinks, corals)
- 5 layer speeds defined: [0.1, 0.2, 0.4, 0.7, 1.0]
- Ambient particles created and updated within background module
- Parallax offsets use modulo wrapping to prevent float precision loss
- Ground rendering is NOT in background.js (stays in renderer.js)
- `assets/sprites/` directory exists
- Game runs without errors (background not yet wired into main.js)
</verification>

<success_criteria>
- createBackground() returns object with update(gameSpeed, deltaTime) and draw(ctx)
- Sky gradient uses 4-stop warm palette
- Far, mid, and near layers are procedurally drawn with distinct colors and shapes
- 15 ambient particles drift through the background
- Factory function pattern matches project conventions
- assets/sprites/ directory ready for sprite files
</success_criteria>

<output>
After completion, create `.planning/phases/06-visual-polish/06-02-SUMMARY.md`
</output>
