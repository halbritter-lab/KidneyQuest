---
phase: 06-visual-polish
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - js/renderer.js
autonomous: true

must_haves:
  truths:
    - "Player rendering supports sprite sheet frames with fallback to procedural zebra"
    - "Obstacle rendering supports sprite sheet frames with fallback to colored rectangles"
    - "Gene rendering has pulsing glow effect and supports sprite sheet with fallback to circles"
    - "All sprite rendering uses Math.round for pixel-crisp positions"
  artifacts:
    - path: "js/renderer.js"
      provides: "Sprite-based entity rendering with fallback paths"
      exports: ["drawPlayer", "drawObstacles", "drawGenes"]
      contains: "ZEBRA_FRAME_START"
  key_links:
    - from: "js/renderer.js"
      to: "js/sprites.js"
      via: "import SPRITES"
      pattern: "import.*SPRITES.*from.*sprites"
    - from: "js/renderer.js"
      to: "ctx.drawImage 9-param"
      via: "sprite sheet frame extraction"
      pattern: "drawImage"
    - from: "js/renderer.js"
      to: "ctx.shadowBlur"
      via: "gene glow effect"
      pattern: "shadowBlur"
---

<objective>
Add sprite-based rendering paths to `renderer.js` for the player (zebra sprite sheet), obstacles (kidney-themed sprites), and genes (with glow effect). Each path checks `SPRITES[key] !== null` and falls back to existing procedural rendering when sprites are unavailable.

Purpose: This is the core visual upgrade -- entities transition from colored rectangles to sprite-based art when PNG files are available, while gracefully degrading to the procedural drawing when they're not. The gene glow effect (VIZP-05) is implemented here regardless of sprite availability.

Output: Extended `renderer.js` with sprite-aware `drawPlayer`, `drawObstacles`, and new `drawGenes` function.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-visual-polish/06-CONTEXT.md
@.planning/phases/06-visual-polish/06-RESEARCH.md
@.planning/phases/06-visual-polish/06-01-SUMMARY.md
@js/renderer.js
@js/sprites.js
@js/player.js
@js/config.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sprite-based player rendering with frame lookup table</name>
  <files>js/renderer.js</files>
  <action>
At the top of `renderer.js`, add import: `import { SPRITES } from './sprites.js';`

Add a `ZEBRA_FRAME_START` lookup table as a module-level constant mapping animation states to their starting frame index in the horizontal sprite strip:
```javascript
const ZEBRA_FRAME_START = {
  idle:       0,   // frames 0-3
  run:        4,   // frames 4-9
  jump:       10,  // frames 10-11
  fall:       12,  // frames 12-13
  land:       14,  // frames 14-16
  doubleJump: 17,  // frames 17-18
  death:      19,  // frames 19-22
};
```

Add sprite frame constants:
```javascript
const SPRITE_FRAME_W = 64;   // width of one frame in sprite sheet
const SPRITE_FRAME_H = 80;   // height of one frame in sprite sheet
```

Modify the existing `drawPlayer()` function:
- Keep the existing squash/stretch transform logic (ctx.save, translate to bottom-centre, scale, translate back)
- AFTER the transforms, add a sprite branch BEFORE the existing try-catch:
  ```javascript
  if (SPRITES.zebra) {
    ctx.imageSmoothingEnabled = false;
    const stateStart = ZEBRA_FRAME_START[player.animState] ?? 0;
    const frameIndex = stateStart + (player.animFrame ?? 0);
    const sx = frameIndex * SPRITE_FRAME_W;
    ctx.drawImage(
      SPRITES.zebra,
      sx, 0, SPRITE_FRAME_W, SPRITE_FRAME_H,
      0, 0, config.PLAYER_WIDTH, config.PLAYER_HEIGHT
    );
  } else {
    // Existing procedural fallback (drawZebraFrame + colored rectangle catch)
    try {
      drawZebraFrame(ctx, config.PLAYER_WIDTH, config.PLAYER_HEIGHT, player.animState, player.animFrame);
    } catch (e) {
      ctx.fillStyle = config.PLAYER_COLOR;
      ctx.fillRect(0, 0, config.PLAYER_WIDTH, config.PLAYER_HEIGHT);
    }
  }
  ```
- The existing `drawZebraFrame` function stays untouched as the procedural fallback

**Important:** Use `Math.round()` on drawImage destination coordinates for pixel-crisp rendering. Since we're drawing at (0,0) relative to the translated context, this is already integer. But add a comment noting this for future maintainers.

**Important:** `ctx.imageSmoothingEnabled = false` must be set BEFORE drawImage calls for crisp pixel art. Set it inside the sprite branch (not globally) to avoid affecting procedural drawing which benefits from smooth arcs.
  </action>
  <verify>
- grep renderer.js for `ZEBRA_FRAME_START` -- should show 7 animation states including death
- grep renderer.js for `SPRITES.zebra` -- should show the sprite branch in drawPlayer
- grep renderer.js for `imageSmoothingEnabled = false` -- should appear before drawImage
- Open game in browser: player should still render as procedural zebra (SPRITES.zebra is null)
- No console errors
  </verify>
  <done>
drawPlayer checks SPRITES.zebra first, uses 9-param drawImage with ZEBRA_FRAME_START lookup for sprite rendering, falls back to existing procedural drawZebraFrame when sprites are null. Death state mapped to frames 19-22. Game renders identically until sprite PNGs are provided.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add obstacle sprite rendering and gene glow effect</name>
  <files>js/renderer.js</files>
  <action>
**Obstacle sprite rendering:**

Add obstacle sprite frame constants:
```javascript
const OBS_FRAME_W = 48;    // width of one obstacle frame in sprite sheet
const OBS_FRAME_H = 56;    // height of one obstacle frame in sprite sheet
const OBS_SPRITE_INDEX = {  // maps obstacle type name to frame index
  'kidney-stone':  0,
  'toxin':         1,
  'salt-crystal':  2,
};
```

Modify `drawObstacles(ctx, obstacles)`:
- For each obstacle, check `SPRITES.obstacles`:
  - If available: use `ctx.drawImage` 9-param to extract the correct frame based on `OBS_SPRITE_INDEX[obs.type]`. Set `ctx.imageSmoothingEnabled = false` before drawing. Use `Math.round(obs.x)` and `Math.round(obs.y)` for crisp positioning.
  - If null: keep existing `ctx.fillRect` colored rectangle rendering (current behavior)
- Add a subtle idle animation: obstacles should have a slight "breathing" pulse. Use a `pulseFactor` based on time (pass timestamp or use a module-level timer). The pulse scales the obstacle height by +/- 3% using `Math.sin`. This is purely visual -- it does NOT affect the hitbox.
  - If you use a pulse: wrap the draw in ctx.save/restore, translate to bottom-center of obstacle, apply ctx.scale(1.0, 1.0 + pulse), translate back, then draw.

**Gene rendering with glow (new function):**

Create a new exported function `drawGenes(ctx, genes)` for rendering gene collectibles with glow:
- For each gene in the array:
  - Calculate glow pulse: `const glowPulse = 4 + 3 * Math.abs(Math.sin(gene.floatOffset));`
  - ctx.save()
  - Set `ctx.shadowColor = gene.color` (or `gene.type.color` depending on gene object structure)
  - Set `ctx.shadowBlur = glowPulse` (4-7px pulsing glow)
  - If `SPRITES.genes`:
    - Set `ctx.imageSmoothingEnabled = false`
    - Determine sprite index from gene type (add GENE_SPRITE_INDEX lookup similar to obstacles)
    - Use `ctx.drawImage` 9-param to draw the gene sprite frame
  - Else (procedural fallback):
    - Draw a filled circle using `ctx.arc` at gene center, with gene color
    - Draw the gene name label below (existing behavior from collectible.js draw method)
  - ctx.restore() -- critical to reset shadowBlur

Add gene sprite constants:
```javascript
const GENE_FRAME_W = 32;
const GENE_FRAME_H = 32;
const GENE_SPRITE_INDEX = {
  'PKD1':   0,
  'PKD2':   1,
  'COL4A5': 2,
  'NPHS1':  3,
  'NPHS2':  4,
  'WT1':    5,
};
```

**Anti-patterns to avoid:**
- Do NOT set shadowBlur without ctx.save/restore -- it bleeds onto subsequent draws
- Do NOT skip imageSmoothingEnabled = false for sprite draws
- Use Math.round on all drawImage destination x,y for pixel-crisp results

Update the module's exports to include `drawGenes` in addition to existing exports.
  </action>
  <verify>
- grep renderer.js for `drawGenes` -- should be an exported function
- grep renderer.js for `shadowBlur` -- should appear in drawGenes with save/restore wrapping
- grep renderer.js for `OBS_SPRITE_INDEX` and `GENE_SPRITE_INDEX` -- both should exist
- Open game in browser:
  - Obstacles should render as colored rectangles with subtle breathing pulse
  - Genes are not yet visible (Phase 5 adds gene spawning) -- but the function exists for when they are
  - No console errors
  </verify>
  <done>
drawObstacles supports sprite sheet rendering with colored rectangle fallback and subtle breathing pulse animation. drawGenes exported with shadowBlur glow effect, sprite support, and procedural circle fallback. All sprite draws use imageSmoothingEnabled = false and Math.round positioning. shadowBlur properly wrapped in save/restore to prevent bleed.
  </done>
</task>

</tasks>

<verification>
- renderer.js imports SPRITES from sprites.js
- ZEBRA_FRAME_START maps all 7 animation states (idle, run, jump, fall, land, doubleJump, death)
- drawPlayer uses SPRITES.zebra when available, falls back to drawZebraFrame
- drawObstacles uses SPRITES.obstacles when available, falls back to fillRect
- drawObstacles has subtle breathing pulse animation
- drawGenes exported with glow effect (shadowBlur + shadowColor)
- drawGenes uses SPRITES.genes when available, falls back to arc circles
- All sprite draws set imageSmoothingEnabled = false
- All drawImage positions use Math.round
- No console errors, game plays identically to before
</verification>

<success_criteria>
- Player rendering has sprite path with fallback (VIZP-01, VIZP-02, VIZP-03 ready)
- Obstacle rendering has sprite path with fallback (VIZP-04 ready)
- Gene rendering has glow effect working in both sprite and procedural modes (VIZP-05)
- All sprite rendering is pixel-crisp
- No regressions in existing gameplay
</success_criteria>

<output>
After completion, create `.planning/phases/06-visual-polish/06-03-SUMMARY.md`
</output>
