---
phase: 03-game-loop-scrolling
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - js/input.js
  - js/main.js
  - js/renderer.js
autonomous: false

must_haves:
  truths:
    - "Pressing Space on READY screen triggers a 3-2-1-Go! countdown with large pulsing numbers before gameplay starts"
    - "During RUNNING, a distance counter (meters) displays in the top-right corner"
    - "Pressing Escape or P during RUNNING pauses the game with a dimmed overlay and 'PAUSED' text"
    - "Unpausing resumes gameplay without a physics jump or ground skip"
    - "GAME_OVER state shows player flashing for ~1 second, then 'Game Over' text, then pulsing restart prompt after cooldown"
    - "Space during GAME_OVER cooldown is ignored; Space after cooldown returns to READY"
    - "Ground scrolls at slow speed during COUNTDOWN, full speed during RUNNING, and freezes during PAUSED and GAME_OVER"
  artifacts:
    - path: "js/input.js"
      provides: "Extended setupInput with onPause callback for Escape/P keys"
      exports: ["setupInput", "inputState"]
    - path: "js/main.js"
      provides: "Five-state machine (READY/COUNTDOWN/RUNNING/PAUSED/GAME_OVER), countdown logic, pause toggle, game over with cooldown, distance counter, groundOffset per-state speed"
      contains: "COUNTDOWN"
    - path: "js/renderer.js"
      provides: "drawCountdown, drawPauseOverlay, drawGameOver, drawHUD functions"
      exports: ["setupCanvas", "resizeCanvas", "clearCanvas", "drawText", "drawGround", "drawCountdown", "drawPauseOverlay", "drawGameOver", "drawHUD"]
  key_links:
    - from: "js/main.js"
      to: "js/input.js"
      via: "setupInput(canvas, handleAction, handlePause) -- two callbacks"
      pattern: "setupInput\\(canvas,.*handleAction.*handlePause"
    - from: "js/main.js"
      to: "js/renderer.js"
      via: "imports drawCountdown, drawPauseOverlay, drawGameOver, drawHUD"
      pattern: "import.*drawCountdown.*from.*renderer"
    - from: "js/main.js"
      to: "js/config.js"
      via: "reads COUNTDOWN_STEP, GAME_OVER_COOLDOWN, GAME_OVER_FREEZE_DELAY for state timing"
      pattern: "CONFIG\\.COUNTDOWN_STEP|CONFIG\\.GAME_OVER_COOLDOWN"
---

<objective>
Implement the complete five-state machine (READY -> COUNTDOWN -> RUNNING -> PAUSED -> GAME_OVER) with all state-specific behavior: 3-2-1-Go! countdown animation, pause/resume with delta-time safety, game over with player flash effect and restart cooldown, and a distance counter HUD. Extend input.js with a pause callback.

Purpose: Transforms the prototype into a real game loop with proper state management. After this plan, the game has a complete lifecycle (start -> play -> die -> restart) that Phase 4 and 5 build on for obstacles, collision, and scoring.

Output: Working five-state game with countdown, pause, game over, distance counter, and all visual overlays.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-game-loop-scrolling/03-CONTEXT.md
@.planning/phases/03-game-loop-scrolling/03-RESEARCH.md
@.planning/phases/03-game-loop-scrolling/03-01-SUMMARY.md
@js/config.js
@js/renderer.js
@js/input.js
@js/main.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend input.js with pause callback and implement five-state machine in main.js</name>
  <files>js/input.js, js/main.js</files>
  <action>
**In input.js:**

Extend `setupInput` to accept a third parameter `onPause` (default `() => {}`). Add Escape and P key handling to the existing keydown listener:

```javascript
export function setupInput(canvas, onAction, onPause = () => {}) {
  // ... existing tabIndex, focus, keydown listener ...
  canvas.addEventListener('keydown', (e) => {
    if (e.code === 'Space' || e.code === 'ArrowUp') {
      e.preventDefault();
      inputState.lastAction = performance.now();
      onAction();
    }
    if (e.code === 'Escape' || e.code === 'KeyP') {
      e.preventDefault();
      onPause();
    }
  });
  // ... existing touchstart and touchmove listeners unchanged ...
}
```

The `onPause` default means existing callers (if any outside main.js) don't break.

**In main.js -- complete rewrite of game state and loop logic:**

1. **State variables** (replace the existing simple `gameState = 'READY'`):
```javascript
let gameState = 'READY';

// Countdown sub-state
let countdownValue = 3;
let countdownTimer = 0;

// Game over sub-state
let gameOverTimer = 0;

// Distance tracking
let distance = 0;

// groundOffset is already from Plan 01
```

2. **State transition functions:**

`startCountdown()`: Set `countdownValue = 3`, `countdownTimer = 0`, `gameState = 'COUNTDOWN'`.

`triggerGameOver()`: Set `gameOverTimer = 0`, `gameState = 'GAME_OVER'`. (Phase 4 will call this on collision.)

`togglePause()`: If RUNNING, set `gameState = 'PAUSED'` and `lastTime = 0`. If PAUSED, set `gameState = 'RUNNING'` and `lastTime = 0`. The lastTime=0 reset is CRITICAL -- prevents huge delta on resume. The existing Math.min cap (0.1s) handles the first resumed frame.

`resetGame()`: Set `distance = 0`, `groundOffset = 0`, `gameState = 'READY'`. (Phase 2+ will also reset player position here.)

3. **handleAction function** (replace existing):
- READY: call `startCountdown()` (NOT directly to RUNNING)
- RUNNING: no-op for now (Phase 2 adds jump)
- GAME_OVER: only if `gameOverTimer >= CONFIG.GAME_OVER_COOLDOWN`, call `resetGame()`
- COUNTDOWN: ignore (can't skip countdown)
- PAUSED: ignore (use Escape/P to unpause, not Space)

4. **handlePause function** (new):
- Only acts if `gameState === 'RUNNING' || gameState === 'PAUSED'`
- Calls `togglePause()`

5. **Update setupInput call:** `setupInput(canvas, handleAction, handlePause)`

6. **Update functions** (called from game loop):

`updateCountdown(deltaTime)`: Accumulate `countdownTimer += deltaTime`. When `countdownTimer >= CONFIG.COUNTDOWN_STEP`, decrement `countdownValue` and reset `countdownTimer -= CONFIG.COUNTDOWN_STEP`. When `countdownValue < 0`, transition to RUNNING: `gameState = 'RUNNING'`, `distance = 0`.

`updateGameOver(deltaTime)`: Accumulate `gameOverTimer += deltaTime`. (Drawing logic uses this timer to decide what to show.)

`updateDistance(deltaTime)`: Only when RUNNING: `distance += CONFIG.GAME_SPEED * deltaTime`.

7. **Rewrite game loop** to handle all 5 states:

```javascript
function gameLoop(timestamp) {
  const deltaTime = Math.min((timestamp - lastTime) / 1000, 0.1);
  lastTime = timestamp;

  clearCanvas(ctx, CONFIG);

  // Update and draw ground based on state
  if (gameState === 'READY' || gameState === 'COUNTDOWN') {
    groundOffset += CONFIG.READY_SCROLL_SPEED * deltaTime;
  } else if (gameState === 'RUNNING') {
    groundOffset += CONFIG.GAME_SPEED * deltaTime;
  }
  // PAUSED and GAME_OVER: groundOffset unchanged (ground freezes)

  drawGround(ctx, CONFIG, groundOffset);

  // State-specific update and render
  if (gameState === 'READY') {
    renderStartScreen(ctx, timestamp);
  } else if (gameState === 'COUNTDOWN') {
    updateCountdown(deltaTime);
    drawCountdown(ctx, CONFIG, countdownValue, countdownTimer);
  } else if (gameState === 'RUNNING') {
    updateDistance(deltaTime);
    // Phase 2+: updatePlayer, drawPlayer here
    drawHUD(ctx, CONFIG, distance);
  } else if (gameState === 'PAUSED') {
    // Phase 2+: drawPlayer (frozen position) here
    drawHUD(ctx, CONFIG, distance);  // show distance while paused
    drawPauseOverlay(ctx, CONFIG);
  } else if (gameState === 'GAME_OVER') {
    updateGameOver(deltaTime);
    drawHUD(ctx, CONFIG, distance);  // show final distance
    drawGameOver(ctx, CONFIG, gameOverTimer);
  }

  requestAnimationFrame(gameLoop);
}
```

Keep the existing `renderStartScreen` function for the READY state. Remove the old RUNNING placeholder text ("Game Running...").

**Important anti-patterns to avoid (from RESEARCH.md):**
- Do NOT use cancelAnimationFrame for pause -- keep the loop running, check state in body
- Do NOT use setTimeout for countdown -- use delta-time accumulator
- Do NOT accept Space input during GAME_OVER before cooldown expires
- Do NOT forget to reset lastTime=0 on pause entry AND resume
- Ground must freeze during PAUSED and GAME_OVER (don't update groundOffset)
- Countdown ground scrolls at READY speed (slow), not RUNNING speed
  </action>
  <verify>
Open index.html in browser:
1. READY screen shows title and pulsing prompt, ground scrolls slowly
2. Press Space: countdown appears (3, 2, 1, Go!) over ~3.2 seconds, ground continues slow scroll
3. After "Go!" disappears, state is RUNNING -- ground scrolls fast, distance counter visible in top-right
4. Press Escape or P: game pauses, ground freezes, "PAUSED" text visible. Distance counter still shown.
5. Press Escape or P again: game resumes without ground skip or physics jump
6. No console errors in any state
  </verify>
  <done>Five-state machine operational. READY shows start screen. Space triggers 3-2-1-Go! countdown. RUNNING scrolls ground at full speed with distance HUD. Pause freezes everything with safe delta-time resume. handleAction and handlePause callbacks wired through extended setupInput.</done>
</task>

<task type="auto">
  <name>Task 2: Add renderer functions for countdown, pause overlay, game over, and HUD</name>
  <files>js/renderer.js</files>
  <action>
Add four new exported functions to renderer.js. Each receives only ctx, config, and the data it needs to render -- no game state logic in the renderer.

**1. `drawCountdown(ctx, config, countdownValue, countdownTimer)`**

Draws the countdown number (3, 2, 1) or "Go!" centered on screen with a size pulse effect.

- Label: if `countdownValue > 0`, show the number as a string. If `countdownValue === 0`, show `'Go!'`.
- Size pulse: font size starts large and shrinks slightly over the step duration. Calculate `pulse = 1.0 - (countdownTimer / config.COUNTDOWN_STEP) * 0.3` and use `fontSize = Math.round(120 * pulse)`.
- Color: `config.COUNTDOWN_COLOR` for numbers (gold), `config.COUNTDOWN_GO_COLOR` for "Go!" (green).
- Position: centered horizontally and vertically on canvas.
- Use the existing `drawText` helper with the computed font string.

**2. `drawPauseOverlay(ctx, config)`**

Draws a semi-transparent dark overlay covering the entire canvas, with "PAUSED" text centered.

- Overlay: `ctx.fillStyle = 'rgba(0, 0, 0, 0.5)'`, fill the entire canvas (0, 0, CANVAS_WIDTH, CANVAS_HEIGHT).
- Text: "PAUSED" centered, bold 64px sans-serif, white color.
- Subtext: "Press Escape to resume" below, 24px sans-serif, white with alpha 0.7.
- Use `drawText` for both text elements.
- IMPORTANT: Use ctx.save/restore around the overlay fill to avoid polluting global alpha state.

**3. `drawGameOver(ctx, config, gameOverTimer)`**

Draws the game over sequence based on how much time has elapsed.

Phase 1 (flash, `gameOverTimer < config.GAME_OVER_FREEZE_DELAY`):
- No text shown yet. (Phase 2+ will flash the player sprite here -- for now this phase is just "waiting".)

Phase 2 (text, `gameOverTimer >= config.GAME_OVER_FREEZE_DELAY`):
- Draw "Game Over" at center, bold 72px sans-serif, color `config.GAME_OVER_COLOR` (red).
- If `gameOverTimer >= config.GAME_OVER_COOLDOWN + config.GAME_OVER_FREEZE_DELAY` (total time), show pulsing "Press Space to restart" below, 28px sans-serif, white, with alpha pulsing like the start screen prompt: `alpha = 0.3 + 0.7 * Math.abs(Math.sin(gameOverTimer * 3))`.

Wait -- looking at the config and research more carefully: GAME_OVER_COOLDOWN is measured from the START of GAME_OVER state. So:
- Flash phase: 0 to GAME_OVER_FREEZE_DELAY (1.0s)
- Show "Game Over" text: after GAME_OVER_FREEZE_DELAY
- Show restart prompt: after GAME_OVER_COOLDOWN (1.0s from start, which overlaps with freeze delay)

Correction: Make the cooldown START after the freeze delay. So restart prompt appears at `gameOverTimer >= config.GAME_OVER_FREEZE_DELAY + config.GAME_OVER_COOLDOWN` (2.0s total). Update the handleAction guard to match: Space accepted when `gameOverTimer >= config.GAME_OVER_FREEZE_DELAY + config.GAME_OVER_COOLDOWN`. This gives the player time to see the Game Over text before restart is available.

**4. `drawHUD(ctx, config, distance)`**

Draws the distance counter in the top-right corner.

- Calculate meters: `Math.floor(distance / config.PX_PER_METER)`
- Display: `${meters}m` at position `(config.CANVAS_WIDTH - 30, 40)`, right-aligned, bold 28px sans-serif, color `config.HUD_COLOR` (gold).
- Use `drawText` with `align: 'right'` and `baseline: 'top'`.

**Update the export list** at the top or ensure all four functions are exported with `export function`.

**Do NOT modify any existing function behavior** (setupCanvas, resizeCanvas, clearCanvas, drawText, drawGround must remain unchanged from Plan 01).
  </action>
  <verify>
All 5 states should render correctly:
1. READY: title + pulsing prompt + slow-scrolling ground (unchanged from Plan 01)
2. COUNTDOWN: large pulsing numbers (3, 2, 1, Go!) centered, gold/green colors
3. RUNNING: distance counter in top-right corner showing "Xm" in gold, ground scrolling fast
4. PAUSED: dimmed overlay with "PAUSED" text and resume instructions
5. GAME_OVER: "Game Over" in red appears after 1s, "Press Space to restart" with pulse appears after 2s

Verify in console: no errors. Switch between states multiple times to confirm no visual artifacts.
  </verify>
  <done>Four new renderer functions (drawCountdown, drawPauseOverlay, drawGameOver, drawHUD) exported from renderer.js. Each function is pure rendering -- receives data, draws to canvas, no state logic. All visual overlays use the existing drawText helper where possible.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete five-state game loop with scrolling ground, 3-2-1-Go! countdown, pause/resume, game over with cooldown, and distance counter HUD. Config expanded with bold colors and rich entity data arrays.</what-built>
  <how-to-verify>
Open index.html in a browser and test the full game lifecycle:

1. **READY screen**: Verify the ground scrolls slowly with visible blue dash markers. Title "KidneyQuest" and pulsing "Press Space to Start" are visible.

2. **Countdown**: Press Space. Verify a 3-2-1-Go! countdown appears with large pulsing numbers (gold) followed by "Go!" (green). Ground continues scrolling slowly during countdown.

3. **RUNNING**: After countdown, verify the ground scrolls at full speed. A distance counter ("0m", "1m", "2m"...) should appear in the top-right in gold. Let it run for a few seconds to see distance accumulate.

4. **Pause**: Press Escape or P. Verify the game dims with a semi-transparent overlay showing "PAUSED" and resume instructions. Ground and distance counter are frozen. Press Escape/P again to resume -- ground should continue smoothly without any jump.

5. **Game Over** (temporary test): Open console and type `gameState = 'GAME_OVER'` (or if a triggerGameOver function is exposed, use that). Verify: ~1 second of nothing visible (flash phase without a player yet), then "Game Over" in red, then after another second "Press Space to restart" pulsing. Press Space -- should return to READY screen.

6. **Config console test**: Open console. Type `CONFIG.GENE_TYPES.length` -- should be 6. Type `CONFIG.GENE_TYPES[5].geneName` -- should be "Wilms Tumor Protein 1". Type `CONFIG.OBSTACLE_TYPES[2].name` -- should be "cyst".

7. **Color check**: Overall palette should feel bold and playful -- bright blue ground surface, gold distance counter, vibrant countdown colors.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues to fix</resume-signal>
</task>

</tasks>

<verification>
- Five game states work: READY -> COUNTDOWN -> RUNNING -> PAUSED (toggle) -> GAME_OVER -> READY
- Ground scrolls at correct speed per state (slow on READY/COUNTDOWN, full on RUNNING, frozen on PAUSED/GAME_OVER)
- Countdown shows 3-2-1-Go! with visual pulse animation
- Pause overlay dims screen with "PAUSED" text; resume has no delta-time jump
- Game Over shows text after freeze delay; restart only accepted after cooldown
- Distance counter displays and accumulates during RUNNING
- Config has 3 rich obstacle types and 6 rich gene types
- No console errors in any state or transition
</verification>

<success_criteria>
1. All five states (READY, COUNTDOWN, RUNNING, PAUSED, GAME_OVER) transition correctly and render their appropriate visuals
2. Ground scrolls seamlessly with dash markers at state-appropriate speeds
3. Pause/resume is delta-time safe (no ground skip, no physics jump)
4. Game Over has a visible freeze/flash delay before showing text, and a cooldown before accepting restart input
5. Distance counter accumulates during RUNNING and displays in gold
6. Input extended with pause support (Escape/P) without breaking existing Space/ArrowUp/touch actions
7. Config contains rich entity arrays ready for Phase 4+ consumption
</success_criteria>

<output>
After completion, create `.planning/phases/03-game-loop-scrolling/03-02-SUMMARY.md`
</output>
