---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - js/main.js
  - js/input.js
  - js/renderer.js
autonomous: false

must_haves:
  truths:
    - "Opening index.html displays a centered 1280x720 canvas with deep dark blue-black (#1a1a2e) background"
    - "'KidneyQuest' title text is visible on the canvas"
    - "'Press Space to Start' text pulses with a smooth animation on the canvas"
    - "A horizontal ground line is visible at the bottom of the canvas"
    - "Pressing Space or tapping the screen transitions the game away from the start screen"
    - "Canvas scales to fit the browser viewport while maintaining 16:9 aspect ratio"
    - "CONFIG object is accessible in browser console and values are mutable"
  artifacts:
    - path: "js/main.js"
      provides: "Module entry point: canvas setup, game loop, state management, window.CONFIG exposure"
      contains: "window.CONFIG"
    - path: "js/input.js"
      provides: "Keyboard (Space, ArrowUp) and touch input handling with preventDefault"
      contains: "passive: false"
    - path: "js/renderer.js"
      provides: "Canvas drawing operations: background fill, text rendering, ground line"
      contains: "getContext"
  key_links:
    - from: "js/main.js"
      to: "js/config.js"
      via: "import default"
      pattern: "import CONFIG from"
    - from: "js/main.js"
      to: "js/input.js"
      via: "import setupInput or InputHandler"
      pattern: "import.*from.*input"
    - from: "js/main.js"
      to: "js/renderer.js"
      via: "import renderer functions"
      pattern: "import.*from.*renderer"
    - from: "js/main.js"
      to: "window.CONFIG"
      via: "global exposure for console tweaking"
      pattern: "window\\.CONFIG\\s*="
    - from: "js/input.js"
      to: "canvas"
      via: "addEventListener with passive:false for touch"
      pattern: "passive:\\s*false"
---

<objective>
Wire the interactive modules for KidneyQuest's start screen: input handling, canvas rendering, game loop, and responsive scaling.

Purpose: This plan creates the interactive experience -- when the user opens index.html, they see the animated start screen and can press Space or tap to transition states. This completes the Phase 1 foundation.
Output: Three modules (main.js, input.js, renderer.js) that produce a working start screen with pulsing text, ground line, and input handling.
</objective>

<execution_context>
@C:\Users\bernt\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\bernt\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-CONTEXT.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

@js/config.js
@index.html
@css/style.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create input.js and renderer.js modules</name>
  <files>js/input.js, js/renderer.js</files>
  <action>
**js/input.js** -- Rewrite the existing POC input handler. Create a module that exports a setup function and state object.

Architecture: Export a function `setupInput(canvas, onAction)` that:
1. Sets `canvas.tabIndex = 0` (backup, HTML should already have it)
2. Calls `canvas.focus()` to auto-focus on setup
3. Adds keydown listener on the CANVAS (not window) for 'Space' and 'ArrowUp':
   - Calls `e.preventDefault()` to prevent page scroll
   - Calls `onAction()` callback
4. Adds touchstart listener on canvas with `{passive: false}`:
   - Calls `e.preventDefault()` to prevent scroll/zoom/bounce
   - Calls `onAction()`
5. Adds touchmove listener on canvas with `{passive: false}`:
   - Only `e.preventDefault()` (blocks scroll during drag)

The `onAction` callback is how main.js handles input. In Phase 1, it triggers state transition (READY -> PLAYING). In Phase 2+, it will also trigger jump.

Also export a simple state tracker if needed for Phase 2+ (e.g., `export const inputState = { lastAction: 0 }`), but keep it minimal. The main contract is the callback pattern.

Why keydown on canvas (not window): Scopes input to the game, prevents interference with other page elements. The canvas has tabindex="0" and is auto-focused so this works immediately.

**js/renderer.js** -- Rewrite the existing POC renderer. Create a module with canvas setup and drawing utilities.

Export these named functions:

`setupCanvas(canvas, config)`:
- Gets 2d context
- Applies high-DPI scaling: `const dpr = Math.min(window.devicePixelRatio || 1, 2)` (cap at 2 per RESEARCH.md open question #2)
- Sets canvas.width = config.CANVAS_WIDTH * dpr
- Sets canvas.height = config.CANVAS_HEIGHT * dpr
- Calls ctx.scale(dpr, dpr)
- Returns { ctx, dpr }

`resizeCanvas(canvas, config)`:
- Calculates scale = Math.min(window.innerWidth / config.CANVAS_WIDTH, window.innerHeight / config.CANVAS_HEIGHT)
- Sets canvas.style.width and canvas.style.height accordingly
- Called on window resize and on init

`clearCanvas(ctx, config)`:
- Fills entire canvas with config.BACKGROUND_COLOR (not clearRect -- we want the dark blue-black fill)

`drawText(ctx, text, x, y, options)`:
- ctx.save()
- Sets font, fillStyle, textAlign ('center'), textBaseline ('middle')
- Supports options: { font, color, alpha, align, baseline }
- If alpha provided, sets ctx.globalAlpha
- ctx.fillText(text, x, y)
- ctx.restore()

`drawGroundLine(ctx, config)`:
- Draws a horizontal line at config.GROUND_Y
- Color: config.GROUND_COLOR
- Width: config.GROUND_LINE_WIDTH (from config, default 2)
- Spans full canvas width: from x=0 to x=config.CANVAS_WIDTH
- Use ctx.fillRect(0, config.GROUND_Y, config.CANVAS_WIDTH, config.GROUND_LINE_WIDTH)

Use named exports for all functions (not a class). This keeps the module simple and tree-shakeable.
  </action>
  <verify>
Read js/input.js and confirm:
1. Exports setupInput function
2. Uses {passive: false} on touchstart and touchmove
3. Listens on canvas element (not window)
4. Calls e.preventDefault() for Space and ArrowUp

Read js/renderer.js and confirm:
1. Exports setupCanvas, resizeCanvas, clearCanvas, drawText, drawGroundLine
2. setupCanvas applies devicePixelRatio with cap at 2
3. drawText uses ctx.save/restore and supports alpha option
4. clearCanvas fills with BACKGROUND_COLOR
  </verify>
  <done>input.js handles keyboard (Space, ArrowUp) and touch input with proper preventDefault; renderer.js provides canvas setup with high-DPI support and drawing utilities</done>
</task>

<task type="auto">
  <name>Task 2: Create main.js with game loop and start screen</name>
  <files>js/main.js</files>
  <action>
Rewrite js/main.js (replacing POC version). This is the module entry point that wires everything together.

Structure:

1. **Imports:**
   - `import CONFIG from './config.js'`
   - `import { setupCanvas, resizeCanvas, clearCanvas, drawText, drawGroundLine } from './renderer.js'`
   - `import { setupInput } from './input.js'`

2. **Global exposure:**
   - `window.CONFIG = CONFIG` -- so workshop participants can tweak values in console
   - Log: `console.log('KidneyQuest v1.0 -- CONFIG available in console')`

3. **Canvas initialization:**
   - Get canvas: `document.getElementById('game-canvas')`
   - Call setupCanvas(canvas, CONFIG) to get { ctx, dpr }
   - Call resizeCanvas(canvas, CONFIG) for initial sizing
   - Add window resize listener that calls resizeCanvas(canvas, CONFIG)

4. **Game state:**
   - `let gameState = 'READY'` -- simple string state ('READY', 'RUNNING', 'GAME_OVER')
   - Phase 1 only uses READY and transitions to RUNNING on input. The RUNNING state just shows a blank canvas with ground line (no player yet -- that's Phase 2).

5. **Input setup:**
   - Call setupInput(canvas, handleAction)
   - `handleAction` function:
     - If gameState === 'READY': set gameState = 'RUNNING', log 'Game started!'
     - If gameState === 'GAME_OVER': set gameState = 'READY' (restart -- for Phase 5)
     - If gameState === 'RUNNING': no-op for now (Phase 2 adds jump)

6. **Game loop (requestAnimationFrame):**
   - `let lastTime = 0`
   - `function gameLoop(timestamp)`:
     - Calculate deltaTime = (timestamp - lastTime) / 1000, cap at 0.1 (prevents huge jumps on tab switch)
     - lastTime = timestamp
     - Call clearCanvas(ctx, CONFIG)
     - Call drawGroundLine(ctx, CONFIG)
     - If gameState === 'READY': call renderStartScreen(ctx, timestamp)
     - If gameState === 'RUNNING': (empty for now -- Phase 2 adds player rendering)
     - requestAnimationFrame(gameLoop)
   - Start with: `requestAnimationFrame(gameLoop)`

7. **renderStartScreen(ctx, timestamp):**
   - Draw "KidneyQuest" title: centered horizontally, positioned at roughly 35% from top (CONFIG.CANVAS_HEIGHT * 0.35)
     - Font: bold 64px sans-serif (or similar large size)
     - Color: CONFIG.TEXT_COLOR (#FFFFFF)
   - Draw "Press Space to Start" prompt: centered horizontally, positioned at roughly 55% from top (CONFIG.CANVAS_HEIGHT * 0.55)
     - Font: 28px sans-serif
     - Pulsing alpha: `0.3 + 0.7 * Math.abs(Math.sin(timestamp / 500))` (smooth oscillation between 0.3 and 1.0)
     - Color: CONFIG.TEXT_COLOR
   - The ground line is already drawn in the main loop (visible in all states)

IMPORTANT notes:
- Do NOT import or reference game.js, player.js, background.js, obstacle.js, collectible.js, or score.js. Those are POC files that will be rewritten in later phases. main.js in Phase 1 is standalone.
- The game loop runs continuously even on the start screen (needed for the pulse animation).
- Delta time is calculated but not used in Phase 1 rendering (it will be used in Phase 2+ for physics). Include it now so the loop structure is ready.
  </action>
  <verify>
Serve the project with a local HTTP server (e.g., `npx http-server C:/development/halbritter-lab/KidneyQuest -p 8080 -c-1`) and open http://localhost:8080 in a browser.

Check:
1. Canvas displays with dark blue-black (#1a1a2e) background, centered on darker page
2. "KidneyQuest" title text is visible
3. "Press Space to Start" text pulses smoothly (alpha oscillates)
4. A ground line is visible near the bottom of the canvas
5. No console errors
6. Type `CONFIG` in browser console -- object is accessible and shows all values
7. Type `CONFIG.BACKGROUND_COLOR = '#ff0000'` -- canvas background changes to red on next frame
8. Press Space -- console logs "Game started!", start screen text disappears, ground line remains
9. Resize browser window -- canvas scales to fit while maintaining aspect ratio
10. Canvas dimensions in the DOM: width and height attributes should be 1280*dpr and 720*dpr
  </verify>
  <done>main.js wires config, input, and renderer into a working game loop that displays an animated start screen and transitions to RUNNING state on input</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Phase 1 foundation: centered game canvas with animated start screen, responsive scaling, keyboard/touch input, and mutable CONFIG object accessible from browser console.</what-built>
  <how-to-verify>
1. Open http://localhost:8080 in a browser (server should be running from Task 2 verification)
2. Confirm: Dark page with centered canvas showing deep blue-black background
3. Confirm: "KidneyQuest" title text displayed prominently
4. Confirm: "Press Space to Start" text pulsing/blinking smoothly
5. Confirm: Subtle ground line visible near the bottom of the canvas
6. Press Space -- start screen disappears, ground line remains, console shows "Game started!"
7. Open browser console, type `CONFIG` -- verify the full config object is accessible
8. Type `CONFIG.GROUND_COLOR = '#ff0000'` -- ground line turns red
9. Resize the browser window -- canvas scales proportionally
10. (Optional) Test on mobile or DevTools mobile emulation: tap should work, no page scroll/zoom
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues</resume-signal>
</task>

</tasks>

<verification>
Phase 1 success criteria (from ROADMAP.md):
1. Opening index.html in a browser displays a centered canvas with dark background -- no console errors
2. "Press Space to Start" text is visible on the canvas
3. Pressing Space or tapping the screen transitions the game away from the start screen
4. All game constants (canvas size, physics values, speeds) live in a single config.js file
5. Canvas scales to fit the browser viewport while maintaining aspect ratio
</verification>

<success_criteria>
- Canvas renders at 1280x720 internal resolution with high-DPI support (capped at 2x)
- Start screen shows "KidneyQuest" title + pulsing "Press Space to Start" + ground line
- Space, ArrowUp, and touch all trigger state transition from READY to RUNNING
- CONFIG is globally accessible in browser console and mutable at runtime
- Canvas responsively scales to viewport while maintaining 16:9 ratio
- Zero console errors on load
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
